{% extends 'wallets_demo/base.html' %}
{% load privacy_tags rbac_tags %}

{% block title %}Merchant Portal - {{ org_name }}{% endblock %}

{% block content %}
<div class="card">
    <h2>Merchant Portal</h2>
    <p class="text-muted">Self-service merchant operations: settlement, payout status, API scopes, webhook events.</p>
</div>

{% if not merchants %}
<div class="card">
    <p class="text-muted">No merchant account is linked to your user yet.</p>
</div>
{% endif %}

{% for m in merchants %}
<div class="card">
    <h3>{{ m.code }} - {{ m.name }}</h3>
    <p class="text-muted">Owner: {% if m.owner %}{{ m.owner.username }}{% else %}-{% endif %} | Contact:
        {% if user|can_view_field:"merchant.contact.email" %}
        {{ m.contact_email|mask_email }}
        {% else %}
        ****
        {% endif %}
        /
        {% if user|can_view_field:"merchant.contact.mobile_no" %}
        {{ m.contact_phone|mask_phone }}
        {% else %}
        ****
        {% endif %}
    </p>

    {% with cred=credential_map|get_item:m.id %}
    <h4>API & Webhook</h4>
    {% if cred %}
    {% if user|can_do_action:"merchant.portal_api_update" %}
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="merchant_portal_update_webhook" />
        <input type="hidden" name="merchant_id" value="{{ m.id }}" />
        <div class="form-group"><label>Key ID</label><input type="text" value="{% if user|can_view_field:'merchant.api.key_id' %}{{ cred.key_id }}{% else %}****{% endif %}" disabled /></div>
        <div class="form-group"><label>Scopes (csv)</label><input type="text" name="scopes_csv"
                value="{{ cred.scopes_csv }}" /></div>
        <div class="form-group"><label>Webhook URL</label><input type="url" name="webhook_url"
                value="{% if user|can_view_field:'merchant.api.webhook_url' %}{{ cred.webhook_url }}{% endif %}" {% if not user|can_view_field:'merchant.api.webhook_url' %}placeholder="Hidden by policy"{% endif %} /></div>
        <button class="btn btn-primary" type="submit">Save API Settings</button>
    </form>
    {% else %}
    <p class="text-muted">API settings are visible, but your role cannot update webhook/scopes.</p>
    {% endif %}
    {% else %}
    <p class="text-muted">No credential configured yet. Use Operations Center to rotate credential.</p>
    {% endif %}
    {% endwith %}

    <h4>Recent Settlements</h4>
    <table>
        <thead>
            <tr>
                <th>No</th>
                <th>Period</th>
                <th>Gross</th>
                <th>Fee</th>
                <th>Net</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for s in settlement_map|get_item:m.id %}
            <tr>
                <td>{{ s.settlement_no }}</td>
                <td>{{ s.period_start }} to {{ s.period_end }}</td>
                <td>{% sensitive_value s.gross_amount "settlement_amount" %} {{ s.currency }}</td>
                <td>{% sensitive_value s.fee_amount "settlement_amount" %} {{ s.currency }}</td>
                <td>{% sensitive_value s.net_amount "settlement_amount" %} {{ s.currency }}</td>
                <td>{{ s.status }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-muted" style="text-align:center;">No settlements yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h4>Recent Payouts</h4>
    <table>
        <thead>
            <tr>
                <th>Ref</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Channel</th>
                <th>Destination</th>
                <th>Updated</th>
            </tr>
        </thead>
        <tbody>
            {% for p in payout_map|get_item:m.id %}
            <tr>
                <td>{{ p.payout_reference }}</td>
                <td>{% sensitive_value p.amount "settlement_amount" %} {{ p.currency }}</td>
                <td>{{ p.status }}</td>
                <td>{{ p.payout_channel }}</td>
                <td>
                    {% if user|can_view_field:"settlement.payout.destination_account" %}
                    {{ p.destination_account|default:"-" }}
                    {% else %}
                    ****
                    {% endif %}
                </td>
                <td>{{ p.updated_at|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-muted" style="text-align:center;">No payouts yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h4>Webhook Security Events</h4>
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Nonce</th>
                <th>Sig Valid</th>
                <th>Replay</th>
                <th>Status</th>
                <th>Code</th>
            </tr>
        </thead>
        <tbody>
            {% for e in webhook_map|get_item:m.id %}
            <tr>
                <td>{{ e.created_at|date:"Y-m-d H:i" }}</td>
                <td>{% if user|can_view_field:"merchant.webhook.nonce" %}{{ e.nonce }}{% else %}****{% endif %}</td>
                <td>{% if e.signature_valid %}Y{% else %}N{% endif %}</td>
                <td>{% if e.replay_detected %}Y{% else %}N{% endif %}</td>
                <td>{{ e.status }}</td>
                <td>{{ e.response_code }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-muted" style="text-align:center;">No webhook events yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endfor %}
{% endblock %}
