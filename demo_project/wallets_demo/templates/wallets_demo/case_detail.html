{% extends 'wallets_demo/base.html' %}
{% block title %}Case {{ case_obj.case_no }} - {{ org_name }}{% endblock %}
{% block content %}
<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;flex-wrap:wrap;">
        <div>
            <h2>Case 360: {{ case_obj.case_no }}</h2>
            <p class="text-muted">{{ case_obj.case_type|title }} | Priority: {{ case_obj.priority|title }} | Status: {{ case_obj.status|title }}</p>
            <p><strong>{{ case_obj.title }}</strong></p>
            <p class="text-muted">{{ case_obj.description|default:"No description" }}</p>
        </div>
        <a class="btn btn-outline" href="{% url 'operations_center' %}#oc-cases">Back to Case List</a>
    </div>
</div>

<div class="tab-bar">
    <button class="tab-btn active" data-tab="case-overview" onclick="switchTab(this,'case-overview')">Overview</button>
    <button class="tab-btn" data-tab="case-timeline" onclick="switchTab(this,'case-timeline')">Timeline</button>
    <button class="tab-btn" data-tab="case-linked" onclick="switchTab(this,'case-linked')">Linked Workflows</button>
    <button class="tab-btn" data-tab="case-docs" onclick="switchTab(this,'case-docs')">Documents</button>
</div>

<div class="tab-pane active" id="case-overview">
    <div class="card">
        <h3>Case Profile</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
            <div><strong>Customer:</strong> {{ case_obj.customer.username }}</div>
            <div><strong>Merchant:</strong> {% if case_obj.merchant %}{{ case_obj.merchant.code }} - {{ case_obj.merchant.name }}{% else %}-{% endif %}</div>
            <div><strong>Assigned To:</strong> {% if case_obj.assigned_to %}{{ case_obj.assigned_to.username }}{% else %}-{% endif %}</div>
            <div><strong>Created By:</strong> {{ case_obj.created_by.username }}</div>
            <div><strong>Created:</strong> {{ case_obj.created_at|date:"d M Y H:i" }}</div>
            <div><strong>SLA Due:</strong> {% if case_obj.sla_due_at %}{{ case_obj.sla_due_at|date:"d M Y H:i" }}{% else %}-{% endif %}</div>
            <div><strong>Resolved:</strong> {% if case_obj.resolved_at %}{{ case_obj.resolved_at|date:"d M Y H:i" }}{% else %}-{% endif %}</div>
        </div>
    </div>

    <div class="card">
        <h3>Update Case</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="case_update" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Status</label><select name="status">{% for value,label in case_status_choices %}<option value="{{ value }}" {% if case_obj.status == value %}selected{% endif %}>{{ label }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Priority</label><select name="priority">{% for value,label in case_priority_choices %}<option value="{{ value }}" {% if case_obj.priority == value %}selected{% endif %}>{{ label }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Assigned To</label><select name="assigned_to"><option value="">-- unassigned --</option>{% for u in users %}<option value="{{ u.id }}" {% if case_obj.assigned_to and case_obj.assigned_to.id == u.id %}selected{% endif %}>{{ u.username }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>SLA Due At</label><input type="datetime-local" name="sla_due_at" value="{% if case_obj.sla_due_at %}{{ case_obj.sla_due_at|date:'Y-m-d\\TH:i' }}{% endif %}" /></div>
                <div class="form-group"><label>Title</label><input type="text" name="title" value="{{ case_obj.title }}" required /></div>
                <div class="form-group" style="grid-column:1/-1;"><label>Description</label><textarea name="description" rows="3">{{ case_obj.description }}</textarea></div>
            </div>
            <button class="btn btn-primary" type="submit">Save Case</button>
        </form>
    </div>
</div>

<div class="tab-pane" id="case-timeline">
    <div class="card">
        <h3>Add Note</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="case_note_add" />
            <div class="form-group"><label>Note</label><textarea name="note" rows="3" required></textarea></div>
            <label style="display:flex;gap:0.5rem;margin-bottom:1rem;"><input type="checkbox" name="is_internal" checked />Internal note</label>
            <button class="btn btn-primary" type="submit">Add Note</button>
        </form>
    </div>
    <div class="card">
        <h3>Timeline</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>Time</th><th>Author</th><th>Visibility</th><th>Note</th></tr></thead>
                <tbody>
                    {% for note in notes %}
                    <tr>
                        <td style="font-size:0.78rem;">{{ note.created_at|date:"d M Y H:i" }}</td>
                        <td>{{ note.created_by.username }}</td>
                        <td>{% if note.is_internal %}<span class="badge-pending">Internal</span>{% else %}External{% endif %}</td>
                        <td>{{ note.note }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-muted" style="text-align:center;">No notes yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="tab-pane" id="case-linked">
    <div class="card">
        <h3>Dispute Refunds</h3>
        <div style="overflow-x:auto;"><table><thead><tr><th>ID</th><th>Amount</th><th>Status</th><th>Maker</th><th>Checker</th><th>SLA Due</th></tr></thead><tbody>{% for rr in refunds %}<tr><td>#{{ rr.id }}</td><td>{{ rr.amount }} {{ rr.currency }}</td><td>{{ rr.status }}</td><td>{{ rr.maker.username }}</td><td>{% if rr.checker %}{{ rr.checker.username }}{% else %}-{% endif %}</td><td>{% if rr.sla_due_at %}{{ rr.sla_due_at|date:"d M H:i" }}{% else %}-{% endif %}</td></tr>{% empty %}<tr><td colspan="6" class="text-muted" style="text-align:center;">No refunds linked.</td></tr>{% endfor %}</tbody></table></div>
    </div>

    <div class="card">
        <h3>Chargebacks</h3>
        <div style="overflow-x:auto;"><table><thead><tr><th>No</th><th>Amount</th><th>Status</th><th>Reason</th><th>Assigned</th></tr></thead><tbody>{% for cb in chargebacks %}<tr><td>{{ cb.chargeback_no }}</td><td>{{ cb.amount }} {{ cb.currency }}</td><td>{{ cb.status }}</td><td>{{ cb.reason_code|default:"-" }}</td><td>{% if cb.assigned_to %}{{ cb.assigned_to.username }}{% else %}-{% endif %}</td></tr>{% empty %}<tr><td colspan="5" class="text-muted" style="text-align:center;">No chargebacks linked.</td></tr>{% endfor %}</tbody></table></div>
    </div>

    <div class="card">
        <h3>Monitoring Alerts</h3>
        <div style="overflow-x:auto;"><table><thead><tr><th>ID</th><th>Type</th><th>Severity</th><th>Status</th><th>Assigned</th></tr></thead><tbody>{% for al in alerts %}<tr><td>#{{ al.id }}</td><td>{{ al.alert_type }}</td><td>{{ al.severity }}</td><td>{{ al.status }}</td><td>{% if al.assigned_to %}{{ al.assigned_to.username }}{% else %}-{% endif %}</td></tr>{% empty %}<tr><td colspan="5" class="text-muted" style="text-align:center;">No monitoring alerts linked.</td></tr>{% endfor %}</tbody></table></div>
    </div>

    <div class="card">
        <h3>Related Cashflow Activity</h3>
        <div style="overflow-x:auto;"><table><thead><tr><th>Time</th><th>Merchant</th><th>Flow</th><th>Amount</th><th>Ref</th></tr></thead><tbody>{% for evt in linked_cashflows %}<tr><td style="font-size:0.78rem;">{{ evt.created_at|date:"d M H:i" }}</td><td>{{ evt.merchant.code }}</td><td>{{ evt.flow_type|upper }}</td><td>{{ evt.amount }} {{ evt.currency }}</td><td>{{ evt.reference|default:"-" }}</td></tr>{% empty %}<tr><td colspan="5" class="text-muted" style="text-align:center;">No linked cashflow records.</td></tr>{% endfor %}</tbody></table></div>
    </div>
</div>

<div class="tab-pane" id="case-docs">
    <div class="card">
        <h3>Upload Document</h3>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="case_document_add" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Title</label><input type="text" name="title" required /></div>
                <div class="form-group"><label>Type</label><input type="text" name="document_type" value="evidence" /></div>
                <div class="form-group"><label>File (optional)</label><input type="file" name="document_file" /></div>
                <div class="form-group"><label>External URL (optional)</label><input type="url" name="external_url" /></div>
                <div class="form-group" style="grid-column:1/-1;"><label>Note</label><input type="text" name="note" /></div>
            </div>
            <label style="display:flex;gap:0.5rem;margin-bottom:1rem;"><input type="checkbox" name="is_internal" checked />Internal document</label>
            <button class="btn btn-primary" type="submit">Upload Document</button>
        </form>
    </div>

    <div class="card">
        <h3>Document Registry</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>Time</th><th>Title</th><th>Type</th><th>Source</th><th>Uploader</th><th>Visibility</th></tr></thead>
                <tbody>
                    {% for doc in documents %}
                    <tr>
                        <td style="font-size:0.78rem;">{{ doc.created_at|date:"d M Y H:i" }}</td>
                        <td>{{ doc.title }}</td>
                        <td>{{ doc.document_type }}</td>
                        <td>{% if doc.file %}<a href="{{ doc.file.url }}" target="_blank" rel="noopener">File</a>{% endif %}{% if doc.file and doc.external_url %} / {% endif %}{% if doc.external_url %}<a href="{{ doc.external_url }}" target="_blank" rel="noopener">URL</a>{% endif %}</td>
                        <td>{{ doc.uploaded_by.username }}</td>
                        <td>{% if doc.is_internal %}<span class="badge-pending">Internal</span>{% else %}External{% endif %}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="text-muted" style="text-align:center;">No documents yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
