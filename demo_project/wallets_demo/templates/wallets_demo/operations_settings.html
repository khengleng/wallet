{% extends 'wallets_demo/base.html' %}
{% load rbac_tags %}

{% block title %}System Setting - DJ Wallet{% endblock %}

{% block content %}
<div class="card">
    <h2>System Setting</h2>
    <p class="text-muted">Configure base references and service-specific transaction prefixes for operations go-live.
    </p>
</div>

<div class="card">
    <h3>Core Prefix Settings</h3>
    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            <label>Organization Name</label>
            <input type="text" name="organization_name" maxlength="128"
                value="{{ operation_settings.organization_name }}" required />
        </div>
        <div class="form-group"><label>Merchant ID Prefix</label><input type="text" name="merchant_id_prefix"
                value="{{ operation_settings.merchant_id_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>CIF ID Prefix</label><input type="text" name="cif_id_prefix"
                value="{{ operation_settings.cif_id_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>Wallet ID Prefix</label><input type="text" name="wallet_id_prefix"
                value="{{ operation_settings.wallet_id_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>Default Transaction ID Prefix</label><input type="text"
                name="transaction_id_prefix" value="{{ operation_settings.transaction_id_prefix }}" maxlength="16"
                required /></div>
        <div class="form-group"><label>Journal Entry Prefix</label><input type="text" name="journal_entry_prefix"
                value="{{ operation_settings.journal_entry_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>Case Prefix</label><input type="text" name="case_no_prefix"
                value="{{ operation_settings.case_no_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>Settlement Prefix</label><input type="text" name="settlement_no_prefix"
                value="{{ operation_settings.settlement_no_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>Payout Prefix</label><input type="text" name="payout_ref_prefix"
                value="{{ operation_settings.payout_ref_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>Reconciliation Prefix</label><input type="text" name="recon_no_prefix"
                value="{{ operation_settings.recon_no_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>Chargeback Prefix</label><input type="text" name="chargeback_no_prefix"
                value="{{ operation_settings.chargeback_no_prefix }}" maxlength="16" required /></div>
        <div class="form-group"><label>Access Review Prefix</label><input type="text" name="access_review_no_prefix"
                value="{{ operation_settings.access_review_no_prefix }}" maxlength="16" required /></div>

        <h3 style="margin-top:1.5rem;">Transaction Prefix by Service Type</h3>
        <p class="text-muted">Each service/flow can have its own transaction prefix.</p>
        {% for service_key, prefix in service_prefixes.items %}
        <div class="form-group">
            <label>{{ service_key|upper }} Prefix</label>
            <input type="text" name="service_prefix_{{ service_key }}" value="{{ prefix }}" maxlength="16" required />
        </div>
        {% endfor %}

        <h3 style="margin-top:1.5rem;">Active Currencies</h3>
        <p class="text-muted">Select which currencies are available on this platform for wallets, deposits, transfers,
            and FX.</p>
        <div
            style="display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:0.75rem; margin-bottom:1.25rem;">
            {% for code, name in all_currencies %}
            <label
                style="display:flex; align-items:center; gap:0.5rem; padding:0.6rem 0.75rem; border:1px solid var(--border); border-radius:0.5rem; cursor:pointer; transition:background 0.15s; {% if code in active_currencies %}background:rgba(99,102,241,0.08); border-color:var(--primary);{% endif %}">
                <input type="checkbox" name="enabled_currencies" value="{{ code }}" {% if code in active_currencies%}checked{% endif %} style="width:auto; accent-color:var(--primary);" />
                <span><strong>{{ code }}</strong>&nbsp;<span class="text-muted" style="font-size:0.8rem;">{{ name}}</span></span>
            </label>
            {% endfor %}
        </div>

        <h3 style="margin-top:1.5rem;">Menu Visibility Rules (Configurable)</h3>
        <p class="text-muted">Comma-separated roles per menu key. Example: <code>super_admin,admin,operation</code>.
        </p>
        {% for menu_key, roles in menu_rules.items %}
        <div class="form-group">
            <label>{{ menu_key }}</label>
            <input type="text" name="menu_roles_{{ menu_key }}" value="{{ roles|join:', ' }}" />
            <small class="text-muted">Default: {{ default_menu_rules|get_item:menu_key|join:", " }}</small>
        </div>
        {% endfor %}

        <h3 style="margin-top:1.5rem;">Sensitive Data Visibility</h3>
        <p class="text-muted">Only these roles can view sensitive amounts/balances. Others will see masked values.</p>
        <div class="form-group">
            <label>Sensitive Data Roles</label>
            <input type="text" name="sensitive_data_roles" value="{{ sensitive_data_roles|join:', ' }}" />
            <small class="text-muted">Default: {{ default_sensitive_roles|join:", " }}</small>
        </div>

        <h4 style="margin-top:1rem;">Sensitive Visibility by Domain</h4>
        <p class="text-muted">Granular restriction per sensitive domain (comma-separated roles).</p>
        {% for domain_key, roles in sensitive_domain_rules.items %}
        <div class="form-group">
            <label>{{ domain_key }}</label>
            <input type="text" name="sensitive_roles_{{ domain_key }}" value="{{ roles|join:', ' }}" />
            <small class="text-muted">Default: {{ default_sensitive_domain_rules|get_item:domain_key|join:", " }}</small>
        </div>
        {% endfor %}

        <h3 style="margin-top:1.5rem;">Authorization Policy Matrix</h3>
        <p class="text-muted">Centralized RBAC-by-config for actions and field-level visibility across modules.</p>

        <h4 style="margin-top:1rem;">Action Permissions (who can do)</h4>
        <p class="text-muted">Action key → roles. Any role not listed will not see or execute that action.</p>
        {% for action_key, roles in action_rules.items %}
        <div class="form-group">
            <label>{{ action_key }}</label>
            <input type="text" name="action_roles_{{ action_key }}" value="{{ roles|join:', ' }}" />
            <small class="text-muted">Default: {{ default_action_rules|get_item:action_key|join:", " }}</small>
        </div>
        {% endfor %}

        <h4 style="margin-top:1rem;">Field Visibility (who can view)</h4>
        <p class="text-muted">Field key → roles. Unauthorized roles see masked or hidden field content.</p>
        {% for field_key, roles in field_rules.items %}
        <div class="form-group">
            <label>{{ field_key }}</label>
            <input type="text" name="field_roles_{{ field_key }}" value="{{ roles|join:', ' }}" />
            <small class="text-muted">Default: {{ default_field_rules|get_item:field_key|join:", " }}</small>
        </div>
        {% endfor %}

        <button type="submit" class="btn btn-primary">Save System Setting</button>
    </form>
</div>

<div class="card">
    <h3>Reference Preview</h3>
    <table>
        <thead>
            <tr>
                <th>Reference</th>
                <th>Sample</th>
            </tr>
        </thead>
        <tbody>
            {% for label, sample in preview.items %}
            <tr>
                <td>{{ label }}</td>
                <td><code>{{ sample }}</code></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Service Transaction Preview</h3>
    <table>
        <thead>
            <tr>
                <th>Service Type</th>
                <th>Sample Transaction ID</th>
            </tr>
        </thead>
        <tbody>
            {% for service_key, sample in preview_service_txn.items %}
            <tr>
                <td>{{ service_key|upper }}</td>
                <td><code>{{ sample }}</code></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
