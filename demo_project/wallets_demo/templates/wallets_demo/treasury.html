{% extends 'wallets_demo/base.html' %}
{% block title %}Treasury Console - {{ org_name }}{% endblock %}
{% block content %}
<div class="card">
    <h2>Treasury Console</h2>
    <p class="text-muted">Manage internal liquidity movement with maker-checker approval.</p>
    <p class="text-muted">
        Policy: single limit <strong>{{ treasury_policy.single_txn_limit }} {{ treasury_policy.currency }}</strong>,
        daily outflow <strong>{{ treasury_policy.daily_outflow_limit }} {{ treasury_policy.currency }}</strong>,
        super admin checker above <strong>{{ treasury_policy.require_super_admin_above }} {{ treasury_policy.currency }}</strong>.
    </p>
</div>

<div class="tab-bar">
    <button class="tab-btn active" data-tab="tr-tab-accounts" onclick="switchTab(this,'tr-tab-accounts')">üè¶
        Accounts</button>
    {% if can_check_treasury_request %}
    <button class="tab-btn" data-tab="tr-tab-policy" onclick="switchTab(this,'tr-tab-policy')">‚öôÔ∏è Policy</button>
    {% endif %}
    {% if can_make_treasury_request %}
    <button class="tab-btn" data-tab="tr-tab-request" onclick="switchTab(this,'tr-tab-request')">üì§ New Transfer
        Request</button>
    {% endif %}
    <button class="tab-btn" data-tab="tr-tab-my" onclick="switchTab(this,'tr-tab-my')">üìã My Requests</button>
    {% if can_check_treasury_request %}
    <button class="tab-btn" data-tab="tr-tab-checker" onclick="switchTab(this,'tr-tab-checker')">‚úÖ Checker
        Queue</button>
    {% endif %}
</div>

{% if can_check_treasury_request %}
<div class="tab-pane" id="tr-tab-policy">
    <div class="card">
        <h3>Treasury Policy Controls</h3>
        <p class="text-muted">Set transfer thresholds and checker requirements.</p>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="treasury_policy_update">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group">
                    <label for="single_txn_limit">Single Transaction Limit</label>
                    <input id="single_txn_limit" name="single_txn_limit" type="number" step="0.01" min="0.01"
                        value="{{ treasury_policy.single_txn_limit }}" required>
                </div>
                <div class="form-group">
                    <label for="daily_outflow_limit">Daily Outflow Limit</label>
                    <input id="daily_outflow_limit" name="daily_outflow_limit" type="number" step="0.01" min="0.01"
                        value="{{ treasury_policy.daily_outflow_limit }}" required>
                </div>
                <div class="form-group">
                    <label for="require_super_admin_above">Require Super Admin Above</label>
                    <input id="require_super_admin_above" name="require_super_admin_above" type="number" step="0.01"
                        min="0.01" value="{{ treasury_policy.require_super_admin_above }}" required>
                </div>
                <div class="form-group">
                    <label for="policy_currency">Policy Currency</label>
                    <input id="policy_currency" name="currency" type="text" value="{{ treasury_policy.currency }}"
                        maxlength="3" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Policy</button>
        </form>
    </div>
</div>
{% endif %}

<!-- Accounts -->
<div class="tab-pane active" id="tr-tab-accounts">
    {% if can_check_treasury_request %}
    <div class="card">
        <h3>Treasury Account Setup</h3>
        <p class="text-muted">Create new treasury account or update existing account details.</p>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="treasury_account_upsert">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group">
                    <label for="account_id">Existing Account (optional)</label>
                    <select id="account_id" name="account_id">
                        <option value="">Create new account</option>
                        {% for account in all_accounts %}
                        <option value="{{ account.id }}">{{ account.name }} ({{ account.currency }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="account_name">Account Name</label>
                    <input id="account_name" name="name" type="text" required>
                </div>
                <div class="form-group">
                    <label for="account_currency">Currency</label>
                    <select id="account_currency" name="currency" required>
                        {% for c in supported_currencies %}
                        <option value="{{ c }}">{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="account_balance">Opening / Current Balance</label>
                    <input id="account_balance" name="balance" type="number" step="0.01" min="0" value="0">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Account</button>
        </form>
    </div>
    {% endif %}

    <div class="card">
        <h3>Treasury Accounts</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Currency</th>
                        <th>Balance</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts %}
                    <tr>
                        <td>{{ account.name }}</td>
                        <td>{{ account.currency }}</td>
                        <td style="font-weight:600;">${{ account.balance }}</td>
                        <td>
                            {% if account.is_active %}<span class="badge-active">Active</span>
                            {% else %}<span class="badge-closed">Inactive</span>{% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-muted" style="text-align:center;">No treasury accounts found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if can_check_treasury_request %}
    <div class="card">
        <h3>Account Status Control</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Currency</th>
                        <th>Balance</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in all_accounts %}
                    <tr>
                        <td>{{ account.name }}</td>
                        <td>{{ account.currency }}</td>
                        <td>{{ account.balance }}</td>
                        <td>{% if account.is_active %}<span class="badge-active">Active</span>{% else %}<span class="badge-closed">Inactive</span>{% endif %}</td>
                        <td>
                            <form method="post" style="display:flex;gap:0.4rem;">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="treasury_account_toggle">
                                <input type="hidden" name="account_id" value="{{ account.id }}">
                                {% if account.is_active %}
                                <button class="btn btn-outline" type="submit" name="action" value="deactivate">Deactivate</button>
                                {% else %}
                                <button class="btn btn-primary" type="submit" name="action" value="activate">Activate</button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-muted" style="text-align:center;">No treasury accounts configured.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- New Transfer Request -->
{% if can_make_treasury_request %}
<div class="tab-pane" id="tr-tab-request">
    <div class="card">
        <h3>Submit Treasury Transfer Request</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="treasury_transfer_request">
            <div class="form-group">
                <label for="from_account">From Account</label>
                <select id="from_account" name="from_account" required>
                    <option value="" selected disabled>Select source account</option>
                    {% for account in accounts %}<option value="{{ account.id }}">{{ account.name }} ({{ account.currency }})</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="to_account">To Account</label>
                <select id="to_account" name="to_account" required>
                    <option value="" selected disabled>Select destination account</option>
                    {% for account in accounts %}<option value="{{ account.id }}">{{ account.name }} ({{ account.currency }})</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="amount">Amount</label>
                <input id="amount" name="amount" type="number" step="0.01" min="0.01" required>
            </div>
            <div class="form-group">
                <label for="reason">Reason</label>
                <input id="reason" name="reason" type="text" placeholder="e.g. top up settlement account">
            </div>
            <div class="form-group">
                <label for="maker_note">Maker Note</label>
                <textarea id="maker_note" name="maker_note" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit Request</button>
        </form>
    </div>
</div>
{% endif %}

<!-- My Requests -->
<div class="tab-pane" id="tr-tab-my">
    <div class="card">
        <h3>My Treasury Requests</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Amount</th>
                        <th>Required Checker Role</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in my_requests %}
                    <tr>
                        <td>#{{ req.id }}</td>
                        <td>{{ req.from_account.name }}</td>
                        <td>{{ req.to_account.name }}</td>
                        <td style="font-weight:600;">${{ req.amount }}</td>
                        <td>{% if req.required_checker_role %}{{ req.required_checker_role }}{% else %}-{% endif %}</td>
                        <td>
                            {% if req.status == "approved" %}<span class="badge-active">{{ req.status }}</span>
                            {% elif req.status == "rejected" %}<span class="badge-blocked">{{ req.status }}</span>
                            {% else %}<span class="badge-pending">{{ req.status }}</span>{% endif %}
                        </td>
                        <td style="font-size:0.8rem; color:var(--text-muted);">{{ req.created_at|date:"d M Y H:i" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-muted" style="text-align:center;">No treasury requests yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Checker Queue -->
{% if can_check_treasury_request %}
<div class="tab-pane" id="tr-tab-checker">
    <div class="card">
        <h3>Treasury Checker Queue</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Maker</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Amount</th>
                        <th>Required Checker Role</th>
                        <th>Reason</th>
                        <th>Decision</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in pending_requests %}
                    <tr>
                        <td>#{{ req.id }}</td>
                        <td>{{ req.maker.username }}</td>
                        <td>{{ req.from_account.name }}</td>
                        <td>{{ req.to_account.name }}</td>
                        <td style="font-weight:600;">${{ req.amount }}</td>
                        <td>{% if req.required_checker_role %}{{ req.required_checker_role }}{% else %}-{% endif %}</td>
                        <td>{{ req.reason }}</td>
                        <td>
                            <form method="post" action="{% url 'treasury_decision' req.id %}"
                                style="display:flex; gap:0.4rem; align-items:center;">
                                {% csrf_token %}
                                <input type="text" name="checker_note" placeholder="Note (optional)"
                                    style="max-width:140px;">
                                <button type="submit" class="btn btn-primary" name="decision"
                                    value="approve">Approve</button>
                                <button type="submit" class="btn btn-outline" name="decision"
                                    value="reject">Reject</button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-muted" style="text-align:center;">No pending treasury requests.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
