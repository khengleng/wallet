{% extends 'wallets_demo/base.html' %}
{% block title %}Policy Hub - {{ org_name }}{% endblock %}

{% block extra_style %}
<style>
  .policy-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  }

  .policy-card {
    border: 1px solid var(--border);
    border-radius: 0.85rem;
    padding: 1rem;
    background: #fff;
  }

  .policy-card h4 {
    margin: 0 0 0.35rem;
  }

  .policy-muted {
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .policy-kpi {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.55rem;
    border-radius: 999px;
    background: #eef2ff;
    color: #3730a3;
    font-size: 0.72rem;
    font-weight: 700;
  }

  .policy-flag-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.65rem;
    margin-top: 0.6rem;
  }

  .policy-flag-row label {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    margin: 0;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .policy-table-wrap {
    overflow-x: auto;
  }

  .policy-table td {
    vertical-align: top;
    font-size: 0.88rem;
  }

  .policy-code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight: 700;
  }
</style>
{% endblock %}

{% block content %}
<div class="card">
  <h2>Policy Hub</h2>
  <p class="text-muted">Central control for customer and merchant class-of-service rules. Define what each class can do and assign classes to CIF and merchant profiles.</p>
</div>

<div class="policy-grid">
  <div class="card" style="margin-bottom:0;">
    <h3>Create or Update Service Class Policy</h3>
    <p class="policy-muted">Use code names like <code>A</code>, <code>B</code>, <code>Z</code>. Leave limits blank for no limit.</p>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="form_type" value="policy_upsert" />
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
        <div class="form-group">
          <label>Existing Policy (optional for update)</label>
          <select name="policy_id">
            <option value="">Create New</option>
            {% for p in all_policies %}
            <option value="{{ p.id }}">#{{ p.id }} - {{ p.entity_type }} - {{ p.code }} ({{ p.name }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Entity Type</label>
          <select name="entity_type" required>
            <option value="customer">Customer</option>
            <option value="merchant">Merchant</option>
          </select>
        </div>
        <div class="form-group">
          <label>Code</label>
          <input type="text" name="code" maxlength="8" placeholder="A" required />
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" name="name" maxlength="64" placeholder="Class A - Unrestricted" required />
        </div>
        <div class="form-group" style="grid-column:1/-1;">
          <label>Description</label>
          <input type="text" name="description" maxlength="255" placeholder="Optional description" />
        </div>
      </div>

      <div class="policy-flag-row">
        <label><input type="checkbox" name="is_active" checked /> Active</label>
        <label><input type="checkbox" name="allow_deposit" checked /> Deposit</label>
        <label><input type="checkbox" name="allow_withdraw" checked /> Withdraw</label>
        <label><input type="checkbox" name="allow_transfer" checked /> Transfer</label>
        <label><input type="checkbox" name="allow_fx" checked /> FX</label>
      </div>
      <div class="policy-flag-row">
        <label><input type="checkbox" name="allow_b2b" checked /> B2B</label>
        <label><input type="checkbox" name="allow_b2c" checked /> B2C</label>
        <label><input type="checkbox" name="allow_c2b" checked /> C2B</label>
        <label><input type="checkbox" name="allow_p2g" checked /> P2G</label>
        <label><input type="checkbox" name="allow_g2p" checked /> G2P</label>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-top:1rem;">
        <div class="form-group">
          <label>Single Txn Limit</label>
          <input type="number" name="single_txn_limit" min="0.01" step="0.01" />
        </div>
        <div class="form-group">
          <label>Daily Txn Count Limit</label>
          <input type="number" name="daily_txn_count_limit" min="1" step="1" />
        </div>
        <div class="form-group">
          <label>Daily Amount Limit</label>
          <input type="number" name="daily_amount_limit" min="0.01" step="0.01" />
        </div>
        <div class="form-group">
          <label>Monthly Txn Count Limit</label>
          <input type="number" name="monthly_txn_count_limit" min="1" step="1" />
        </div>
        <div class="form-group">
          <label>Monthly Amount Limit</label>
          <input type="number" name="monthly_amount_limit" min="0.01" step="0.01" />
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Save Policy</button>
    </form>
  </div>

  <div class="card" style="margin-bottom:0;">
    <h3>Customer Policy Upgrade (Maker-Checker)</h3>
    <form method="post" style="margin-bottom:1rem;">
      {% csrf_token %}
      <input type="hidden" name="form_type" value="policy_upgrade_customer_request" />
      <div class="form-group">
        <label>Customer CIF</label>
        <select name="cif_id" required>
          {% for cif in customer_cifs %}
          <option value="{{ cif.id }}">{{ cif.cif_no }} - {{ cif.user.username }} ({{ cif.legal_name }}) [{% if cif.service_class %}{{ cif.service_class.code }}{% else %}UNASSIGNED{% endif %}]</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Target Policy</label>
        <select name="target_policy_id" required>
          {% for p in customer_policies %}
          <option value="{{ p.id }}">{{ p.code }} - {{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Maker Note</label>
        <input type="text" name="maker_note" maxlength="255" placeholder="Reason for class upgrade" />
      </div>
      <button type="submit" class="btn btn-primary">Submit Upgrade Request</button>
    </form>

    <h3 style="margin-top:1.25rem;">Assign Policy to Merchant</h3>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="form_type" value="policy_assign_merchant" />
      <div class="form-group">
        <label>Merchant</label>
        <select name="merchant_id" required>
          {% for m in merchants %}
          <option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Policy</label>
        <select name="policy_id">
          <option value="">Unassign</option>
          {% for p in merchant_policies %}
          <option value="{{ p.id }}">{{ p.code }} - {{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Apply Merchant Policy</button>
    </form>
  </div>
</div>

<div class="card">
  <h3>Pending Customer Class Upgrade Requests</h3>
  <div class="policy-table-wrap">
    <table class="policy-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>CIF</th>
          <th>From</th>
          <th>To</th>
          <th>Status</th>
          <th>Maker</th>
          <th>Checker</th>
          <th>Decision</th>
        </tr>
      </thead>
      <tbody>
        {% for req in customer_upgrade_requests %}
        <tr>
          <td>#{{ req.id }}</td>
          <td><code>{{ req.cif.cif_no }}</code></td>
          <td>{% if req.from_service_class %}{{ req.from_service_class.code }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
          <td>{{ req.to_service_class.code }}</td>
          <td>{{ req.status }}</td>
          <td>{{ req.maker.username }}</td>
          <td>{% if req.checker %}{{ req.checker.username }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
          <td>
            {% if req.status == 'pending' and can_decide_customer_upgrade %}
            <form method="post" style="display:flex;gap:0.35rem;align-items:center;">
              {% csrf_token %}
              <input type="hidden" name="form_type" value="policy_upgrade_customer_decision" />
              <input type="hidden" name="request_id" value="{{ req.id }}" />
              <input type="text" name="checker_note" maxlength="255" placeholder="Checker note" />
              <button class="btn btn-primary" type="submit" name="decision" value="approve">Approve</button>
              <button class="btn btn-outline" type="submit" name="decision" value="reject">Reject</button>
            </form>
            {% else %}
            <span class="text-muted">No action</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-muted" style="text-align:center;">No upgrade requests.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Current Assignments</h3>
  <div class="policy-grid">
    <div class="policy-card">
      <h4>Customer CIF Assignments</h4>
      <div class="policy-table-wrap">
        <table class="policy-table">
          <thead>
            <tr>
              <th>CIF</th>
              <th>User</th>
              <th>Status</th>
              <th>Policy</th>
            </tr>
          </thead>
          <tbody>
            {% for cif in customer_cifs %}
            <tr>
              <td><code>{{ cif.cif_no }}</code></td>
              <td>{{ cif.user.username }}</td>
              <td>{{ cif.status }}</td>
              <td>{% if cif.service_class %}<span class="policy-code">{{ cif.service_class.code }}</span> - {{ cif.service_class.name }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-muted" style="text-align:center;">No CIF records.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="policy-card">
      <h4>Merchant Assignments</h4>
      <div class="policy-table-wrap">
        <table class="policy-table">
          <thead>
            <tr>
              <th>Merchant</th>
              <th>Name</th>
              <th>Policy</th>
            </tr>
          </thead>
          <tbody>
            {% for m in merchants %}
            <tr>
              <td><code>{{ m.code }}</code></td>
              <td>{{ m.name }}</td>
              <td>{% if m.service_class %}<span class="policy-code">{{ m.service_class.code }}</span> - {{ m.service_class.name }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-muted" style="text-align:center;">No merchants.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <h3>Tariff Rules</h3>
  <p class="policy-muted">Configure how fees are charged by transaction type, payer/payee entity, and class of service. Fee can be charged to payer or payee.</p>
  <form method="post" style="margin-bottom:1rem;">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="tariff_upsert" />
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:0.9rem;">
      <div class="form-group">
        <label>Existing Tariff (optional update)</label>
        <select name="tariff_id">
          <option value="">Create New</option>
          {% for t in tariff_rules %}
          <option value="{{ t.id }}">#{{ t.id }} - {{ t.transaction_type|upper }} - {{ t.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Tariff Name</label>
        <input type="text" name="name" maxlength="96" required />
      </div>
      <div class="form-group">
        <label>Transaction Type</label>
        <select name="transaction_type" required>
          {% for value, label in tariff_txn_type_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Priority</label>
        <input type="number" name="priority" min="0" value="100" />
      </div>
      <div class="form-group">
        <label>Currency (blank = any)</label>
        <input type="text" name="currency" maxlength="12" placeholder="USD" />
      </div>
      <div class="form-group">
        <label>Charge Side</label>
        <select name="charge_side">
          {% for value, label in tariff_charge_side_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Fee Mode</label>
        <select name="fee_mode">
          {% for value, label in tariff_fee_mode_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Fee Value</label>
        <input type="number" name="fee_value" step="0.000001" min="0.000001" required />
      </div>
      <div class="form-group">
        <label>Minimum Fee (optional)</label>
        <input type="number" name="minimum_fee" step="0.01" min="0.01" />
      </div>
      <div class="form-group">
        <label>Maximum Fee (optional)</label>
        <input type="number" name="maximum_fee" step="0.01" min="0.01" />
      </div>
      <div class="form-group">
        <label>Payer Entity</label>
        <select name="payer_entity_type">
          {% for value, label in tariff_entity_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Payee Entity</label>
        <select name="payee_entity_type">
          {% for value, label in tariff_entity_choices %}
          <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Payer Service Class (optional)</label>
        <select name="payer_service_class_id">
          <option value="">Any</option>
          {% for p in all_policies %}
          <option value="{{ p.id }}">{{ p.entity_type }} - {{ p.code }} - {{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Payee Service Class (optional)</label>
        <select name="payee_service_class_id">
          <option value="">Any</option>
          {% for p in all_policies %}
          <option value="{{ p.id }}">{{ p.entity_type }} - {{ p.code }} - {{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Minimum Amount (optional)</label>
        <input type="number" name="min_amount" step="0.01" min="0.01" />
      </div>
      <div class="form-group">
        <label>Maximum Amount (optional)</label>
        <input type="number" name="max_amount" step="0.01" min="0.01" />
      </div>
      <div class="form-group" style="grid-column:1/-1;">
        <label>Description</label>
        <input type="text" name="description" maxlength="255" />
      </div>
    </div>
    <div class="policy-flag-row">
      <label><input type="checkbox" name="is_active" checked /> Active</label>
    </div>
    <button type="submit" class="btn btn-primary">Save Tariff Rule</button>
  </form>

  <div class="policy-table-wrap">
    <table class="policy-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Txn Type</th>
          <th>Name</th>
          <th>Side</th>
          <th>Target</th>
          <th>Fee</th>
          <th>Band</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for t in tariff_rules %}
        <tr>
          <td>{{ t.id }}</td>
          <td><code>{{ t.transaction_type|upper }}</code></td>
          <td>{{ t.name }}{% if t.description %}<div class="policy-muted">{{ t.description }}</div>{% endif %}</td>
          <td>{{ t.charge_side }}</td>
          <td class="policy-muted">
            Payer: {{ t.payer_entity_type }}{% if t.payer_service_class %} / {{ t.payer_service_class.code }}{% endif %}<br>
            Payee: {{ t.payee_entity_type }}{% if t.payee_service_class %} / {{ t.payee_service_class.code }}{% endif %}<br>
            Currency: {{ t.currency|default:"ANY" }}
          </td>
          <td class="policy-muted">
            Mode: {{ t.fee_mode }}<br>
            Value: {{ t.fee_value }}<br>
            Min/Max Fee: {{ t.minimum_fee|default:"-" }} / {{ t.maximum_fee|default:"-" }}
          </td>
          <td class="policy-muted">Amount: {{ t.min_amount|default:"-" }} - {{ t.max_amount|default:"-" }}<br>Priority: {{ t.priority }}</td>
          <td>{% if t.is_active %}<span class="policy-kpi">Active</span>{% else %}<span class="badge-blocked">Inactive</span>{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-muted" style="text-align:center;">No tariff rules yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Customer Policy Catalog</h3>
  <div class="policy-table-wrap">
    <table class="policy-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Code</th>
          <th>Name</th>
          <th>Status</th>
          <th>Actions</th>
          <th>Flows</th>
          <th>Limits</th>
        </tr>
      </thead>
      <tbody>
        {% for p in customer_policies %}
        <tr>
          <td>{{ p.id }}</td>
          <td class="policy-code">{{ p.code }}</td>
          <td>{{ p.name }}{% if p.description %}<div class="policy-muted">{{ p.description }}</div>{% endif %}</td>
          <td>{% if p.is_active %}<span class="policy-kpi">Active</span>{% else %}<span class="badge-blocked">Inactive</span>{% endif %}</td>
          <td class="policy-muted">
            Deposit: {% if p.allow_deposit %}Y{% else %}N{% endif %}<br>
            Withdraw: {% if p.allow_withdraw %}Y{% else %}N{% endif %}<br>
            Transfer: {% if p.allow_transfer %}Y{% else %}N{% endif %}<br>
            FX: {% if p.allow_fx %}Y{% else %}N{% endif %}
          </td>
          <td class="policy-muted">
            B2B: {% if p.allow_b2b %}Y{% else %}N{% endif %}<br>
            B2C: {% if p.allow_b2c %}Y{% else %}N{% endif %}<br>
            C2B: {% if p.allow_c2b %}Y{% else %}N{% endif %}<br>
            P2G: {% if p.allow_p2g %}Y{% else %}N{% endif %}<br>
            G2P: {% if p.allow_g2p %}Y{% else %}N{% endif %}
          </td>
          <td class="policy-muted">
            Single: {{ p.single_txn_limit|default:"-" }}<br>
            Daily Count: {{ p.daily_txn_count_limit|default:"-" }}<br>
            Daily Amount: {{ p.daily_amount_limit|default:"-" }}<br>
            Monthly Count: {{ p.monthly_txn_count_limit|default:"-" }}<br>
            Monthly Amount: {{ p.monthly_amount_limit|default:"-" }}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-muted" style="text-align:center;">No customer policies yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Merchant Policy Catalog</h3>
  <div class="policy-table-wrap">
    <table class="policy-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Code</th>
          <th>Name</th>
          <th>Status</th>
          <th>Actions</th>
          <th>Flows</th>
          <th>Limits</th>
        </tr>
      </thead>
      <tbody>
        {% for p in merchant_policies %}
        <tr>
          <td>{{ p.id }}</td>
          <td class="policy-code">{{ p.code }}</td>
          <td>{{ p.name }}{% if p.description %}<div class="policy-muted">{{ p.description }}</div>{% endif %}</td>
          <td>{% if p.is_active %}<span class="policy-kpi">Active</span>{% else %}<span class="badge-blocked">Inactive</span>{% endif %}</td>
          <td class="policy-muted">
            Deposit: {% if p.allow_deposit %}Y{% else %}N{% endif %}<br>
            Withdraw: {% if p.allow_withdraw %}Y{% else %}N{% endif %}<br>
            Transfer: {% if p.allow_transfer %}Y{% else %}N{% endif %}<br>
            FX: {% if p.allow_fx %}Y{% else %}N{% endif %}
          </td>
          <td class="policy-muted">
            B2B: {% if p.allow_b2b %}Y{% else %}N{% endif %}<br>
            B2C: {% if p.allow_b2c %}Y{% else %}N{% endif %}<br>
            C2B: {% if p.allow_c2b %}Y{% else %}N{% endif %}<br>
            P2G: {% if p.allow_p2g %}Y{% else %}N{% endif %}<br>
            G2P: {% if p.allow_g2p %}Y{% else %}N{% endif %}
          </td>
          <td class="policy-muted">
            Single: {{ p.single_txn_limit|default:"-" }}<br>
            Daily Count: {{ p.daily_txn_count_limit|default:"-" }}<br>
            Daily Amount: {{ p.daily_amount_limit|default:"-" }}<br>
            Monthly Count: {{ p.monthly_txn_count_limit|default:"-" }}<br>
            Monthly Amount: {{ p.monthly_amount_limit|default:"-" }}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-muted" style="text-align:center;">No merchant policies yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
