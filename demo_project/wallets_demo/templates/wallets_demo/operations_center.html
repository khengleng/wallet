{% extends 'wallets_demo/base.html' %}
{% load privacy_tags %}

{% block title %}Operations Center - DJ Wallet{% endblock %}

{% block content %}
<div class="card">
    <h2>Business Operations Center</h2>
    <p class="text-muted">Manage merchants, customer cases, and loyalty operations in one place.</p>
</div>

<div class="card">
    <h3>Create Merchant</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="merchant_create" />
        <div class="form-group"><label>Merchant Code</label><input type="text" name="merchant_code" required /></div>
        <div class="form-group"><label>Merchant Name</label><input type="text" name="merchant_name" required /></div>
        <div class="form-group"><label>Settlement Currency</label>
            <select name="settlement_currency">
                {% for ccy in supported_currencies %}<option value="{{ ccy }}">{{ ccy }}</option>{% endfor %}
            </select>
        </div>
        <div class="form-group"><label>Wallet Type</label>
            <select name="wallet_type">
                <option value="B">Business (B)</option>
                <option value="G">Government (G)</option>
            </select>
        </div>
        <div class="form-group"><label>Owner User (optional)</label>
            <select name="owner_user_id"><option value="">-- none --</option>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select>
        </div>
        <div class="form-group"><label>Contact Email</label><input type="email" name="contact_email" /></div>
        <div class="form-group"><label>Contact Phone</label><input type="text" name="contact_phone" /></div>
        <div class="form-group"><label>Loyalty Earn Rate</label><input type="number" step="0.0001" min="0.0001" name="earn_rate" value="1.0000" required /></div>
        <div class="form-group"><label>Loyalty Redeem Rate</label><input type="number" step="0.0001" min="0.0001" name="redeem_rate" value="1.0000" required /></div>
        <div class="form-group"><label>Single Txn Limit</label><input type="number" step="0.01" min="0.01" name="single_txn_limit" value="50000" required /></div>
        <div class="form-group"><label>Daily Txn Limit</label><input type="number" min="1" name="daily_txn_limit" value="5000" required /></div>
        <div class="form-group"><label>Daily Amount Limit</label><input type="number" step="0.01" min="0.01" name="daily_amount_limit" value="1000000" required /></div>
        <div class="form-group"><label>Reserve Ratio (bps)</label><input type="number" min="0" name="reserve_ratio_bps" value="0" /></div>
        <div class="form-group"><label>Manual Review Threshold</label><input type="number" step="0.01" min="0" name="require_manual_review_above" value="0" /></div>
        <div class="form-group"><label><input type="checkbox" name="is_high_risk" /> High Risk Merchant</label></div>
        <div class="form-group"><label><input type="checkbox" name="loyalty_enabled" checked /> Loyalty Enabled</label></div>
        <div class="form-group">
            <label>Wallet Flow Capabilities</label>
            <label><input type="checkbox" name="supports_b2b" checked /> B2B</label>
            <label><input type="checkbox" name="supports_b2c" checked /> B2C</label>
            <label><input type="checkbox" name="supports_c2b" checked /> C2B</label>
            <label><input type="checkbox" name="supports_p2g" /> P2G</label>
            <label><input type="checkbox" name="supports_g2p" /> G2P</label>
        </div>
        <button class="btn btn-primary" type="submit">Create Merchant</button>
    </form>
</div>

<div class="card">
    <h3>Manage Merchants</h3>
    <table>
        <thead>
            <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Status</th>
                <th>Wallet Type</th>
                <th>Owner</th>
                <th>Contact</th>
                <th>Capabilities</th>
                <th>Loyalty</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for m in merchants %}
                <tr>
                    <td>{{ m.code }}</td>
                    <td>{{ m.name }}</td>
                    <td>{{ m.status }}</td>
                    <td>{{ m.wallet_type }}</td>
                    <td>{% if m.owner %}{{ m.owner.username }}{% else %}-{% endif %}</td>
                    <td>{{ m.contact_email|mask_email }} / {{ m.contact_phone|mask_phone }}</td>
                    <td>
                        {% with cap=m.wallet_capability %}
                            B2B:{% if cap.supports_b2b %}Y{% else %}N{% endif %},
                            B2C:{% if cap.supports_b2c %}Y{% else %}N{% endif %},
                            C2B:{% if cap.supports_c2b %}Y{% else %}N{% endif %},
                            P2G:{% if cap.supports_p2g %}Y{% else %}N{% endif %},
                            G2P:{% if cap.supports_g2p %}Y{% else %}N{% endif %}
                        {% endwith %}
                    </td>
                    <td>
                        {% with p=m.loyalty_program %}
                            {% if p.is_enabled %}Enabled{% else %}Disabled{% endif %}
                            ({{ p.earn_rate }}/{{ p.redeem_rate }})
                        {% endwith %}
                    </td>
                    <td>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="merchant_update" />
                            <input type="hidden" name="merchant_id" value="{{ m.id }}" />
                            <select name="status">
                                <option value="active"{% if m.status == "active" %} selected{% endif %}>Active</option>
                                <option value="suspended"{% if m.status == "suspended" %} selected{% endif %}>Suspended</option>
                                <option value="inactive"{% if m.status == "inactive" %} selected{% endif %}>Inactive</option>
                            </select>
                            <select name="owner_user_id">
                                <option value="">-- owner --</option>
                                {% for u in users %}
                                    <option value="{{ u.id }}"{% if m.owner and m.owner.id == u.id %} selected{% endif %}>{{ u.username }}</option>
                                {% endfor %}
                            </select>
                            <select name="wallet_type">
                                <option value="B"{% if m.wallet_type == "B" %} selected{% endif %}>B</option>
                                <option value="G"{% if m.wallet_type == "G" %} selected{% endif %}>G</option>
                            </select>
                            <label><input type="checkbox" name="supports_b2b"{% if m.wallet_capability.supports_b2b %} checked{% endif %} />B2B</label>
                            <label><input type="checkbox" name="supports_b2c"{% if m.wallet_capability.supports_b2c %} checked{% endif %} />B2C</label>
                            <label><input type="checkbox" name="supports_c2b"{% if m.wallet_capability.supports_c2b %} checked{% endif %} />C2B</label>
                            <label><input type="checkbox" name="supports_p2g"{% if m.wallet_capability.supports_p2g %} checked{% endif %} />P2G</label>
                            <label><input type="checkbox" name="supports_g2p"{% if m.wallet_capability.supports_g2p %} checked{% endif %} />G2P</label>
                            <label><input type="checkbox" name="loyalty_enabled"{% if m.loyalty_program.is_enabled %} checked{% endif %} />Loyalty</label>
                            <input type="number" step="0.0001" min="0.0001" name="earn_rate" value="{{ m.loyalty_program.earn_rate }}" style="max-width:110px;" />
                            <input type="number" step="0.0001" min="0.0001" name="redeem_rate" value="{{ m.loyalty_program.redeem_rate }}" style="max-width:110px;" />
                            <input type="email" name="contact_email" value="{{ m.contact_email }}" placeholder="email" style="max-width:180px;" />
                            <input type="text" name="contact_phone" value="{{ m.contact_phone }}" placeholder="phone" style="max-width:140px;" />
                            <button class="btn btn-outline" type="submit">Save</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="9" class="text-muted" style="text-align:center;">No merchants yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Merchant KYB (Maker / Checker)</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="merchant_kyb_submit" />
        <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Legal Name</label><input type="text" name="legal_name" required /></div>
        <div class="form-group"><label>Registration Number</label><input type="text" name="registration_number" /></div>
        <div class="form-group"><label>Tax ID</label><input type="text" name="tax_id" /></div>
        <div class="form-group"><label>Country Code</label><input type="text" name="country_code" maxlength="3" /></div>
        <div class="form-group"><label>Incorporation Document URL</label><input type="url" name="incorporation_doc_url" /></div>
        <div class="form-group"><label>License Document URL</label><input type="url" name="license_doc_url" /></div>
        <div class="form-group"><label>Beneficial Owner Document URL</label><input type="url" name="beneficial_owner_doc_url" /></div>
        <div class="form-group"><label>Risk Note</label><input type="text" name="risk_note" /></div>
        <button class="btn btn-primary" type="submit">Submit KYB</button>
    </form>
</div>

<div class="card">
    <h3>KYB Requests</h3>
    <table>
        <thead><tr><th>ID</th><th>Merchant</th><th>Status</th><th>Legal Name</th><th>Registration</th><th>Maker</th><th>Checker</th><th>Action</th></tr></thead>
        <tbody>
            {% for req in kyb_requests %}
                <tr>
                    <td>#{{ req.id }}</td>
                    <td>{{ req.merchant.code }}</td>
                    <td>{{ req.status }}</td>
                    <td>{{ req.legal_name }}</td>
                    <td>{{ req.registration_number|default:"-" }}</td>
                    <td>{{ req.maker.username }}</td>
                    <td>{% if req.checker %}{{ req.checker.username }}{% else %}-{% endif %}</td>
                    <td>
                        {% if req.status == "pending" %}
                            <form method="post" class="flex gap-2">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="merchant_kyb_decision" />
                                <input type="hidden" name="kyb_request_id" value="{{ req.id }}" />
                                <select name="decision">
                                    <option value="approved">Approve</option>
                                    <option value="rejected">Reject</option>
                                </select>
                                <input type="text" name="checker_note" placeholder="Checker note" />
                                <button class="btn btn-outline" type="submit">Submit</button>
                            </form>
                        {% else %}
                            {{ req.checker_note|default:"-" }}
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="8" class="text-muted" style="text-align:center;">No KYB requests yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Merchant Fee Rules</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="merchant_fee_rule_upsert" />
        <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Flow Type</label><select name="flow_type">{% for value, label in flow_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Percent (bps)</label><input type="number" min="0" name="percent_bps" value="0" /></div>
        <div class="form-group"><label>Fixed Fee</label><input type="number" step="0.01" min="0" name="fixed_fee" value="0" /></div>
        <div class="form-group"><label>Minimum Fee</label><input type="number" step="0.01" min="0" name="minimum_fee" value="0" /></div>
        <div class="form-group"><label>Maximum Fee</label><input type="number" step="0.01" min="0" name="maximum_fee" value="0" /></div>
        <div class="form-group"><label><input type="checkbox" name="is_active" checked /> Active</label></div>
        <button class="btn btn-primary" type="submit">Save Fee Rule</button>
    </form>
    <table>
        <thead><tr><th>Merchant</th><th>Flow</th><th>BPS</th><th>Fixed</th><th>Min</th><th>Max</th><th>Active</th></tr></thead>
        <tbody>
            {% for rule in fee_rules %}
                <tr>
                    <td>{{ rule.merchant.code }}</td>
                    <td>{{ rule.flow_type|upper }}</td>
                    <td>{{ rule.percent_bps }}</td>
                    <td>{{ rule.fixed_fee }}</td>
                    <td>{{ rule.minimum_fee }}</td>
                    <td>{{ rule.maximum_fee }}</td>
                    <td>{% if rule.is_active %}Y{% else %}N{% endif %}</td>
                </tr>
            {% empty %}
                <tr><td colspan="7" class="text-muted" style="text-align:center;">No fee rules yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Merchant Risk Profile</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="merchant_risk_update" />
        <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Single Txn Limit</label><input type="number" step="0.01" min="0.01" name="single_txn_limit" required /></div>
        <div class="form-group"><label>Daily Txn Limit</label><input type="number" min="1" name="daily_txn_limit" required /></div>
        <div class="form-group"><label>Daily Amount Limit</label><input type="number" step="0.01" min="0.01" name="daily_amount_limit" required /></div>
        <div class="form-group"><label>Reserve Ratio (bps)</label><input type="number" min="0" name="reserve_ratio_bps" value="0" /></div>
        <div class="form-group"><label>Manual Review Threshold</label><input type="number" step="0.01" min="0" name="require_manual_review_above" value="0" /></div>
        <div class="form-group"><label><input type="checkbox" name="is_high_risk" /> High Risk</label></div>
        <button class="btn btn-primary" type="submit">Update Risk Profile</button>
    </form>
    <table>
        <thead><tr><th>Merchant</th><th>Single</th><th>Daily Count</th><th>Daily Amount</th><th>Reserve (bps)</th><th>Manual Review</th><th>High Risk</th></tr></thead>
        <tbody>
            {% for risk in risk_profiles %}
                <tr>
                    <td>{{ risk.merchant.code }}</td>
                    <td>{{ risk.single_txn_limit }}</td>
                    <td>{{ risk.daily_txn_limit }}</td>
                    <td>{{ risk.daily_amount_limit }}</td>
                    <td>{{ risk.reserve_ratio_bps }}</td>
                    <td>{{ risk.require_manual_review_above }}</td>
                    <td>{% if risk.is_high_risk %}Y{% else %}N{% endif %}</td>
                </tr>
            {% empty %}
                <tr><td colspan="7" class="text-muted" style="text-align:center;">No risk profiles yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Merchant API Credential & Webhook</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="merchant_api_rotate" />
        <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Scopes (csv)</label><input type="text" name="scopes_csv" value="wallet:read,payout:read,webhook:write" /></div>
        <div class="form-group"><label>Webhook URL</label><input type="url" name="webhook_url" placeholder="https://merchant.example/webhook" /></div>
        <div class="form-group"><label><input type="checkbox" name="is_active" checked /> Credential Active</label></div>
        <button class="btn btn-primary" type="submit">Rotate API Credential</button>
    </form>
    <table>
        <thead><tr><th>Merchant</th><th>Key ID</th><th>Scopes</th><th>Webhook</th><th>Active</th><th>Last Rotated</th></tr></thead>
        <tbody>
            {% for cred in api_credentials %}
                <tr>
                    <td>{{ cred.merchant.code }}</td>
                    <td>{{ cred.key_id }}</td>
                    <td>{{ cred.scopes_csv }}</td>
                    <td>{{ cred.webhook_url|default:"-" }}</td>
                    <td>{% if cred.is_active %}Y{% else %}N{% endif %}</td>
                    <td>{% if cred.last_rotated_at %}{{ cred.last_rotated_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>
                </tr>
            {% empty %}
                <tr><td colspan="6" class="text-muted" style="text-align:center;">No API credentials yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Settlement Management</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="merchant_settlement_create" />
        <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Currency</label><select name="currency">{% for ccy in supported_currencies %}<option value="{{ ccy }}">{{ ccy }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Period Start</label><input type="date" name="period_start" /></div>
        <div class="form-group"><label>Period End</label><input type="date" name="period_end" /></div>
        <button class="btn btn-primary" type="submit">Generate Settlement Draft</button>
    </form>
    <table>
        <thead><tr><th>No</th><th>Merchant</th><th>Period</th><th>Gross</th><th>Fee</th><th>Net</th><th>Events</th><th>Status</th><th>Action</th></tr></thead>
        <tbody>
            {% for s in settlements %}
                <tr>
                    <td>{{ s.settlement_no }}</td>
                    <td>{{ s.merchant.code }}</td>
                    <td>{{ s.period_start }} to {{ s.period_end }}</td>
                    <td>{{ s.gross_amount }} {{ s.currency }}</td>
                    <td>{{ s.fee_amount }} {{ s.currency }}</td>
                    <td>{{ s.net_amount }} {{ s.currency }}</td>
                    <td>{{ s.event_count }}</td>
                    <td>{{ s.status }}</td>
                    <td>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="merchant_settlement_update" />
                            <input type="hidden" name="settlement_id" value="{{ s.id }}" />
                            <select name="status">
                                <option value="draft"{% if s.status == "draft" %} selected{% endif %}>Draft</option>
                                <option value="posted"{% if s.status == "posted" %} selected{% endif %}>Posted</option>
                                <option value="paid"{% if s.status == "paid" %} selected{% endif %}>Paid</option>
                            </select>
                            <button class="btn btn-outline" type="submit">Update</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="9" class="text-muted" style="text-align:center;">No settlements yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Dispute Refund (Maker / Checker)</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="dispute_refund_submit" />
        <div class="form-group"><label>Case</label><select name="case_id" required>{% for item in cases %}<option value="{{ item.id }}">{{ item.case_no }} ({{ item.case_type }})</option>{% endfor %}</select></div>
        <div class="form-group"><label>Amount</label><input type="number" step="0.01" min="0.01" name="amount" required /></div>
        <div class="form-group"><label>Currency</label><select name="currency">{% for ccy in supported_currencies %}<option value="{{ ccy }}">{{ ccy }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Source Cashflow Event ID (optional)</label><input type="number" min="1" name="source_cashflow_event_id" /></div>
        <div class="form-group"><label>Reason</label><input type="text" name="reason" /></div>
        <div class="form-group"><label>Maker Note</label><input type="text" name="maker_note" /></div>
        <button class="btn btn-primary" type="submit">Submit Refund Request</button>
    </form>
    <table>
        <thead><tr><th>ID</th><th>Case</th><th>Merchant</th><th>Customer</th><th>Amount</th><th>Status</th><th>Maker</th><th>Checker</th><th>Action</th></tr></thead>
        <tbody>
            {% for rr in refund_requests %}
                <tr>
                    <td>#{{ rr.id }}</td>
                    <td>{{ rr.case.case_no }}</td>
                    <td>{{ rr.merchant.code }}</td>
                    <td>{{ rr.customer.username }}</td>
                    <td>{{ rr.amount }} {{ rr.currency }}</td>
                    <td>{{ rr.status }}</td>
                    <td>{{ rr.maker.username }}</td>
                    <td>{% if rr.checker %}{{ rr.checker.username }}{% else %}-{% endif %}</td>
                    <td>
                        {% if rr.status == "pending" %}
                            <form method="post" class="flex gap-2">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="dispute_refund_decision" />
                                <input type="hidden" name="refund_request_id" value="{{ rr.id }}" />
                                <select name="decision">
                                    <option value="approve">Approve & Execute</option>
                                    <option value="reject">Reject</option>
                                </select>
                                <input type="text" name="checker_note" placeholder="Checker note" />
                                <button class="btn btn-outline" type="submit">Submit</button>
                            </form>
                        {% else %}
                            {{ rr.checker_note|default:"-" }}
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="9" class="text-muted" style="text-align:center;">No refund requests yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Settlement Payout Execution</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="settlement_payout_submit" />
        <div class="form-group"><label>Settlement</label><select name="settlement_id" required>{% for s in settlements %}<option value="{{ s.id }}">{{ s.settlement_no }} - {{ s.merchant.code }} - {{ s.net_amount }} {{ s.currency }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Payout Channel</label><select name="payout_channel"><option value="bank_transfer">Bank Transfer</option><option value="api">API</option><option value="manual">Manual</option></select></div>
        <div class="form-group"><label>Destination Account</label><input type="text" name="destination_account" /></div>
        <button class="btn btn-primary" type="submit">Submit Payout</button>
    </form>
    <table>
        <thead><tr><th>Ref</th><th>Settlement</th><th>Merchant</th><th>Amount</th><th>Status</th><th>Channel</th><th>Action</th></tr></thead>
        <tbody>
            {% for p in payouts %}
                <tr>
                    <td>{{ p.payout_reference }}</td>
                    <td>{{ p.settlement.settlement_no }}</td>
                    <td>{{ p.settlement.merchant.code }}</td>
                    <td>{{ p.amount }} {{ p.currency }}</td>
                    <td>{{ p.status }}</td>
                    <td>{{ p.payout_channel }}</td>
                    <td>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="settlement_payout_decision" />
                            <input type="hidden" name="payout_id" value="{{ p.id }}" />
                            <select name="decision">
                                <option value="send">Mark Sent</option>
                                <option value="settle">Mark Settled</option>
                                <option value="fail">Mark Failed</option>
                            </select>
                            <button class="btn btn-outline" type="submit">Update</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="7" class="text-muted" style="text-align:center;">No payouts yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Reconciliation Framework</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="reconciliation_run_create" />
        <div class="form-group"><label>Source</label><input type="text" name="source" value="internal_vs_settlement" /></div>
        <div class="form-group"><label>Currency</label><select name="currency">{% for ccy in supported_currencies %}<option value="{{ ccy }}">{{ ccy }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Period Start</label><input type="date" name="period_start" /></div>
        <div class="form-group"><label>Period End</label><input type="date" name="period_end" /></div>
        <div class="form-group"><label>External Count</label><input type="number" min="0" name="external_count" value="0" /></div>
        <div class="form-group"><label>External Amount</label><input type="number" step="0.01" min="0" name="external_amount" value="0" /></div>
        <button class="btn btn-primary" type="submit">Run Reconciliation</button>
    </form>
    <table>
        <thead><tr><th>Run</th><th>Period</th><th>Internal</th><th>External</th><th>Delta Count</th><th>Delta Amount</th><th>Status</th></tr></thead>
        <tbody>
            {% for run in reconciliation_runs %}
                <tr>
                    <td>{{ run.run_no }}</td>
                    <td>{{ run.period_start }} to {{ run.period_end }}</td>
                    <td>{{ run.internal_count }} / {{ run.internal_amount }} {{ run.currency }}</td>
                    <td>{{ run.external_count }} / {{ run.external_amount }} {{ run.currency }}</td>
                    <td>{{ run.delta_count }}</td>
                    <td>{{ run.delta_amount }} {{ run.currency }}</td>
                    <td>{{ run.status }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="7" class="text-muted" style="text-align:center;">No reconciliation runs yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Reconciliation Breaks</h3>
    <table>
        <thead><tr><th>Run</th><th>Reference</th><th>Issue</th><th>Delta</th><th>Status</th><th>Assigned</th><th>Action</th></tr></thead>
        <tbody>
            {% for br in reconciliation_breaks %}
                <tr>
                    <td>{{ br.run.run_no }}</td>
                    <td>{{ br.reference|default:"-" }}</td>
                    <td>{{ br.issue_type }}</td>
                    <td>{{ br.delta_amount }}</td>
                    <td>{{ br.status }}</td>
                    <td>{% if br.assigned_to %}{{ br.assigned_to.username }}{% else %}-{% endif %}</td>
                    <td>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="reconciliation_break_update" />
                            <input type="hidden" name="break_id" value="{{ br.id }}" />
                            <select name="status">
                                <option value="open"{% if br.status == "open" %} selected{% endif %}>Open</option>
                                <option value="in_review"{% if br.status == "in_review" %} selected{% endif %}>In Review</option>
                                <option value="resolved"{% if br.status == "resolved" %} selected{% endif %}>Resolved</option>
                            </select>
                            <select name="assigned_to"><option value="">-- keep --</option>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select>
                            <input type="text" name="note" placeholder="Resolution note" />
                            <button class="btn btn-outline" type="submit">Update</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="7" class="text-muted" style="text-align:center;">No reconciliation breaks yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Chargeback Operations</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="chargeback_create" />
        <div class="form-group"><label>Case</label><select name="case_id" required>{% for item in cases %}<option value="{{ item.id }}">{{ item.case_no }} ({{ item.case_type }})</option>{% endfor %}</select></div>
        <div class="form-group"><label>Amount</label><input type="number" step="0.01" min="0.01" name="amount" required /></div>
        <div class="form-group"><label>Currency</label><select name="currency">{% for ccy in supported_currencies %}<option value="{{ ccy }}">{{ ccy }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Reason Code</label><input type="text" name="reason_code" placeholder="e.g. 10.4" /></div>
        <div class="form-group"><label>Network Reference</label><input type="text" name="network_reference" /></div>
        <div class="form-group"><label>Due At (YYYY-MM-DDTHH:MM:SS)</label><input type="text" name="due_at" /></div>
        <div class="form-group"><label>Source Cashflow Event ID (optional)</label><input type="number" min="1" name="source_cashflow_event_id" /></div>
        <button class="btn btn-primary" type="submit">Create Chargeback</button>
    </form>
    <table>
        <thead><tr><th>No</th><th>Case</th><th>Merchant</th><th>Amount</th><th>Reason</th><th>Status</th><th>Assigned</th><th>Action</th></tr></thead>
        <tbody>
            {% for cb in chargebacks %}
                <tr>
                    <td>{{ cb.chargeback_no }}</td>
                    <td>{{ cb.case.case_no }}</td>
                    <td>{{ cb.merchant.code }}</td>
                    <td>{{ cb.amount }} {{ cb.currency }}</td>
                    <td>{{ cb.reason_code|default:"-" }}</td>
                    <td>{{ cb.status }}</td>
                    <td>{% if cb.assigned_to %}{{ cb.assigned_to.username }}{% else %}-{% endif %}</td>
                    <td>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="chargeback_update" />
                            <input type="hidden" name="chargeback_id" value="{{ cb.id }}" />
                            <select name="status">
                                <option value="open"{% if cb.status == "open" %} selected{% endif %}>Open</option>
                                <option value="represented"{% if cb.status == "represented" %} selected{% endif %}>Represented</option>
                                <option value="pre_arbitration"{% if cb.status == "pre_arbitration" %} selected{% endif %}>Pre-Arbitration</option>
                                <option value="won"{% if cb.status == "won" %} selected{% endif %}>Won</option>
                                <option value="lost"{% if cb.status == "lost" %} selected{% endif %}>Lost</option>
                                <option value="closed"{% if cb.status == "closed" %} selected{% endif %}>Closed</option>
                            </select>
                            <select name="assigned_to"><option value="">-- keep --</option>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select>
                            <button class="btn btn-outline" type="submit">Update</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="8" class="text-muted" style="text-align:center;">No chargebacks yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="chargeback_evidence_add" />
        <div class="form-group"><label>Chargeback</label><select name="chargeback_id" required>{% for cb in chargebacks %}<option value="{{ cb.id }}">{{ cb.chargeback_no }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Document Type</label><input type="text" name="document_type" value="receipt" /></div>
        <div class="form-group"><label>Document URL</label><input type="url" name="document_url" required /></div>
        <div class="form-group"><label>Note</label><input type="text" name="note" /></div>
        <button class="btn btn-primary" type="submit">Upload Evidence</button>
    </form>
    <table>
        <thead><tr><th>Time</th><th>Chargeback</th><th>Type</th><th>URL</th><th>By</th></tr></thead>
        <tbody>
            {% for ev in chargeback_evidences %}
                <tr>
                    <td>{{ ev.created_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ ev.chargeback.chargeback_no }}</td>
                    <td>{{ ev.document_type }}</td>
                    <td>{{ ev.document_url }}</td>
                    <td>{{ ev.uploaded_by.username }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="5" class="text-muted" style="text-align:center;">No chargeback evidence yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Ledger Hardening Controls</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="accounting_period_close_upsert" />
        <div class="form-group"><label>Currency</label><select name="currency">{% for ccy in supported_currencies %}<option value="{{ ccy }}">{{ ccy }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Period Start</label><input type="date" name="period_start" required /></div>
        <div class="form-group"><label>Period End</label><input type="date" name="period_end" required /></div>
        <div class="form-group"><label>Action</label><select name="close_action"><option value="close">Close</option><option value="reopen">Reopen</option></select></div>
        <button class="btn btn-primary" type="submit">Apply Period Action</button>
    </form>
    <table>
        <thead><tr><th>Period</th><th>Currency</th><th>Closed</th><th>Closed By</th><th>Closed At</th></tr></thead>
        <tbody>
            {% for p in accounting_periods %}
                <tr>
                    <td>{{ p.period_start }} to {{ p.period_end }}</td>
                    <td>{{ p.currency }}</td>
                    <td>{% if p.is_closed %}Y{% else %}N{% endif %}</td>
                    <td>{% if p.closed_by %}{{ p.closed_by.username }}{% else %}-{% endif %}</td>
                    <td>{% if p.closed_at %}{{ p.closed_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>
                </tr>
            {% empty %}
                <tr><td colspan="5" class="text-muted" style="text-align:center;">No accounting periods configured.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="journal_backdate_request" />
        <div class="form-group"><label>Journal Entry</label><select name="entry_id">{% for je in journal_entries %}<option value="{{ je.id }}">{{ je.entry_no }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Requested Date</label><input type="date" name="requested_date" required /></div>
        <div class="form-group"><label>Reason</label><input type="text" name="reason" /></div>
        <button class="btn btn-primary" type="submit">Request Backdate Approval</button>
    </form>
    <table>
        <thead><tr><th>Entry</th><th>Date</th><th>Status</th><th>Maker</th><th>Checker</th><th>Action</th></tr></thead>
        <tbody>
            {% for ba in backdate_approvals %}
                <tr>
                    <td>{{ ba.entry.entry_no }}</td>
                    <td>{{ ba.requested_date }}</td>
                    <td>{{ ba.status }}</td>
                    <td>{{ ba.maker.username }}</td>
                    <td>{% if ba.checker %}{{ ba.checker.username }}{% else %}-{% endif %}</td>
                    <td>
                        {% if ba.status == "pending" %}
                            <form method="post" class="flex gap-2">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="journal_backdate_decision" />
                                <input type="hidden" name="approval_id" value="{{ ba.id }}" />
                                <select name="decision"><option value="approve">Approve</option><option value="reject">Reject</option></select>
                                <input type="text" name="checker_note" placeholder="Checker note" />
                                <button class="btn btn-outline" type="submit">Submit</button>
                            </form>
                        {% else %}
                            {{ ba.checker_note|default:"-" }}
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="6" class="text-muted" style="text-align:center;">No backdate approvals yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Risk / AML Operations</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="sanction_screening_run" />
        <div class="form-group"><label>User</label><select name="user_id" required>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Provider</label><input type="text" name="provider" value="internal" /></div>
        <div class="form-group"><label>Reference</label><input type="text" name="reference" /></div>
        <div class="form-group"><label>Score (0-1)</label><input type="number" step="0.0001" min="0" max="1" name="score" value="0.1000" /></div>
        <div class="form-group"><label>Note</label><input type="text" name="note" /></div>
        <button class="btn btn-primary" type="submit">Run Screening</button>
    </form>
    <table>
        <thead><tr><th>Time</th><th>User</th><th>Provider</th><th>Score</th><th>Status</th><th>Ref</th></tr></thead>
        <tbody>
            {% for sr in sanction_screenings %}
                <tr>
                    <td>{{ sr.created_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ sr.user.username }}</td>
                    <td>{{ sr.provider }}</td>
                    <td>{{ sr.score }}</td>
                    <td>{{ sr.status }}</td>
                    <td>{{ sr.reference|default:"-" }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="6" class="text-muted" style="text-align:center;">No sanction screenings yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    <table>
        <thead><tr><th>ID</th><th>Type</th><th>Severity</th><th>Status</th><th>User</th><th>Merchant</th><th>Case</th><th>Action</th></tr></thead>
        <tbody>
            {% for al in monitoring_alerts %}
                <tr>
                    <td>#{{ al.id }}</td>
                    <td>{{ al.alert_type }}</td>
                    <td>{{ al.severity }}</td>
                    <td>{{ al.status }}</td>
                    <td>{% if al.user %}{{ al.user.username }}{% else %}-{% endif %}</td>
                    <td>{% if al.merchant %}{{ al.merchant.code }}{% else %}-{% endif %}</td>
                    <td>{% if al.case %}{{ al.case.case_no }}{% else %}-{% endif %}</td>
                    <td>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="monitoring_alert_update" />
                            <input type="hidden" name="alert_id" value="{{ al.id }}" />
                            <select name="status">
                                <option value="open"{% if al.status == "open" %} selected{% endif %}>Open</option>
                                <option value="in_review"{% if al.status == "in_review" %} selected{% endif %}>In Review</option>
                                <option value="closed"{% if al.status == "closed" %} selected{% endif %}>Closed</option>
                            </select>
                            <select name="assigned_to"><option value="">-- keep --</option>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select>
                            <input type="text" name="note" placeholder="Analyst note" />
                            <button class="btn btn-outline" type="submit">Update</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="8" class="text-muted" style="text-align:center;">No monitoring alerts yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Webhook Signature & Replay Dashboard</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="merchant_webhook_validate" />
        <div class="form-group"><label>Credential</label><select name="credential_id" required>{% for cred in api_credentials %}<option value="{{ cred.id }}">{{ cred.merchant.code }} - {{ cred.key_id }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Event Type</label><input type="text" name="event_type" value="payment.status" /></div>
        <div class="form-group"><label>Nonce</label><input type="text" name="nonce" required /></div>
        <div class="form-group"><label>Payload</label><textarea name="payload" rows="3" required></textarea></div>
        <div class="form-group"><label>Signature</label><input type="text" name="signature" required /></div>
        <button class="btn btn-primary" type="submit">Validate Webhook</button>
    </form>
    <table>
        <thead><tr><th>Time</th><th>Merchant</th><th>Nonce</th><th>Sig Valid</th><th>Replay</th><th>Status</th><th>Code</th></tr></thead>
        <tbody>
            {% for we in webhook_events %}
                <tr>
                    <td>{{ we.created_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ we.credential.merchant.code }}</td>
                    <td>{{ we.nonce }}</td>
                    <td>{% if we.signature_valid %}Y{% else %}N{% endif %}</td>
                    <td>{% if we.replay_detected %}Y{% else %}N{% endif %}</td>
                    <td>{{ we.status }}</td>
                    <td>{{ we.response_code }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="7" class="text-muted" style="text-align:center;">No webhook events yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Access Review (SoD) & Compliance Ops</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="access_review_run" />
        <button class="btn btn-primary" type="submit">Run SoD Access Review</button>
    </form>
    <table>
        <thead><tr><th>Review</th><th>User</th><th>Issue</th><th>Status</th><th>Reviewer</th><th>Action</th></tr></thead>
        <tbody>
            {% for ar in access_reviews %}
                <tr>
                    <td>{{ ar.review_no }}</td>
                    <td>{{ ar.user.username }}</td>
                    <td>{{ ar.issue_type }}</td>
                    <td>{{ ar.status }}</td>
                    <td>{% if ar.reviewer %}{{ ar.reviewer.username }}{% else %}-{% endif %}</td>
                    <td>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="access_review_update" />
                            <input type="hidden" name="review_id" value="{{ ar.id }}" />
                            <select name="status">
                                <option value="open"{% if ar.status == "open" %} selected{% endif %}>Open</option>
                                <option value="resolved"{% if ar.status == "resolved" %} selected{% endif %}>Resolved</option>
                            </select>
                            <button class="btn btn-outline" type="submit">Update</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="6" class="text-muted" style="text-align:center;">No access reviews yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="data_retention_purge" />
        <div class="form-group"><label>Retention days</label><input type="number" name="days" min="1" value="365" /></div>
        <div class="form-group"><label><input type="checkbox" name="dry_run" checked /> Dry run</label></div>
        <button class="btn btn-primary" type="submit">Run Data Retention</button>
    </form>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="release_readiness_check" />
        <button class="btn btn-outline" type="submit">Run Release Readiness Snapshot</button>
    </form>
</div>

<div class="card">
    <h3>Create Case (Complaint / Dispute / Refund)</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="case_create" />
        <div class="form-group"><label>Case Type</label><select name="case_type">{% for value, label in case_type_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Priority</label><select name="case_priority">{% for value, label in case_priority_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Customer</label><select name="case_customer_id" required>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Merchant (optional)</label><select name="case_merchant_id"><option value="">-- none --</option>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Title</label><input type="text" name="case_title" required /></div>
        <div class="form-group"><label>Description</label><textarea name="case_description" rows="3"></textarea></div>
        <button class="btn btn-primary" type="submit">Create Case</button>
    </form>
</div>

<div class="card">
    <h3>User Wallet Type Management</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="user_wallet_type_update" />
        <div class="form-group"><label>User</label>
            <select name="user_id" required>
                {% for u in users %}<option value="{{ u.id }}">{{ u.username }} ({{ u.wallet_type }})</option>{% endfor %}
            </select>
        </div>
        <div class="form-group"><label>Wallet Type</label>
            <select name="wallet_type" required>
                <option value="P">Personal (P)</option>
                <option value="B">Business (B)</option>
                <option value="C">Customer (C)</option>
                <option value="G">Government (G)</option>
            </select>
        </div>
        <button class="btn btn-primary" type="submit">Update Wallet Type</button>
    </form>
</div>

<div class="card">
    <h3>Post Cashflow (B2B / B2C / C2B / P2G / G2P)</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="cashflow_event_create" />
        <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Flow Type</label><select name="flow_type">{% for value, label in flow_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>User (for B2C/C2B/P2G/G2P)</label><select name="user_id"><option value="">-- optional --</option>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Counterparty Merchant (for B2B)</label><select name="counterparty_merchant_id"><option value="">-- optional --</option>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Currency</label><select name="currency">{% for ccy in supported_currencies %}<option value="{{ ccy }}">{{ ccy }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Amount</label><input type="number" step="0.01" min="0.01" name="amount" required /></div>
        <div class="form-group"><label>Reference</label><input type="text" name="reference" /></div>
        <div class="form-group"><label>Note</label><input type="text" name="note" /></div>
        <button class="btn btn-primary" type="submit">Post Cashflow</button>
    </form>
</div>

<div class="card">
    <h3>Create Loyalty Event</h3>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="loyalty_event_create" />
        <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Customer</label><select name="customer_id" required>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Event Type</label><select name="event_type">{% for value, label in event_type_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Flow Type</label><select name="flow_type">{% for value, label in flow_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
        <div class="form-group"><label>Amount</label><input type="number" step="0.01" min="0.01" name="amount" required /></div>
        <div class="form-group"><label>Reference</label><input type="text" name="reference" /></div>
        <div class="form-group"><label>Note</label><input type="text" name="note" /></div>
        <button class="btn btn-primary" type="submit">Record Loyalty Event</button>
    </form>
</div>

<div class="card">
    <h3>Open Cases</h3>
    <table>
        <thead><tr><th>Case</th><th>Type</th><th>Priority</th><th>Status</th><th>Customer</th><th>Merchant</th><th>Assigned</th><th>Action</th></tr></thead>
        <tbody>
            {% for item in cases %}
                <tr>
                    <td>{{ item.case_no }}</td>
                    <td>{{ item.case_type }}</td>
                    <td>{{ item.priority }}</td>
                    <td>{{ item.status }}</td>
                    <td>{{ item.customer.username }}</td>
                    <td>{% if item.merchant %}{{ item.merchant.code }}{% else %}-{% endif %}</td>
                    <td>{% if item.assigned_to %}{{ item.assigned_to.username }}{% else %}-{% endif %}</td>
                    <td>
                        <form method="post" class="flex gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="case_update" />
                            <input type="hidden" name="case_id" value="{{ item.id }}" />
                            <select name="status">{% for value, label in case_status_choices %}<option value="{{ value }}"{% if item.status == value %} selected{% endif %}>{{ label }}</option>{% endfor %}</select>
                            <select name="assigned_to"><option value="">-- unassigned --</option>{% for u in users %}<option value="{{ u.id }}"{% if item.assigned_to and item.assigned_to.id == u.id %} selected{% endif %}>{{ u.username }}</option>{% endfor %}</select>
                            <input type="text" name="note" placeholder="Internal note" />
                            <button class="btn btn-outline" type="submit">Update</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="8" class="text-muted" style="text-align:center;">No cases yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Recent Loyalty Events</h3>
    <table>
        <thead><tr><th>Time</th><th>Merchant</th><th>Customer</th><th>Type</th><th>Flow</th><th>Points</th><th>Amount</th><th>Ref</th></tr></thead>
        <tbody>
            {% for event in loyalty_events %}
                <tr>
                    <td>{{ event.created_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ event.merchant.code }}</td>
                    <td>{{ event.customer.username }}</td>
                    <td>{{ event.event_type }}</td>
                    <td>{{ event.flow_type|upper }}</td>
                    <td>{{ event.points }}</td>
                    <td>{{ event.amount }} {{ event.currency }}</td>
                    <td>{{ event.reference|default:"-" }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="8" class="text-muted" style="text-align:center;">No loyalty events yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Recent Cashflow Events</h3>
    <table>
        <thead><tr><th>Time</th><th>Merchant</th><th>Flow</th><th>Amount</th><th>Fee</th><th>Net</th><th>From User</th><th>To User</th><th>Counterparty Merchant</th><th>Settlement</th><th>Ref</th></tr></thead>
        <tbody>
            {% for event in cashflow_events %}
                <tr>
                    <td>{{ event.created_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ event.merchant.code }}</td>
                    <td>{{ event.flow_type|upper }}</td>
                    <td>{{ event.amount }} {{ event.currency }}</td>
                    <td>{{ event.fee_amount }} {{ event.currency }}</td>
                    <td>{{ event.net_amount }} {{ event.currency }}</td>
                    <td>{% if event.from_user %}{{ event.from_user.username }}{% else %}-{% endif %}</td>
                    <td>{% if event.to_user %}{{ event.to_user.username }}{% else %}-{% endif %}</td>
                    <td>{% if event.counterparty_merchant %}{{ event.counterparty_merchant.code }}{% else %}-{% endif %}</td>
                    <td>{{ event.settlement_reference|default:"-" }}</td>
                    <td>{{ event.reference|default:"-" }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="11" class="text-muted" style="text-align:center;">No cashflow events yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
