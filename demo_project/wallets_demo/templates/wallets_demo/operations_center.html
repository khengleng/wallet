{% extends 'wallets_demo/base.html' %}
{% load privacy_tags %}
{% block title %}Merchant & Case Ops - {{ org_name }}{% endblock %}
{% block content %}
<div class="card">
    <h2>Business Operations Center</h2>
    <p class="text-muted">Manage merchants, customer cases, and loyalty operations in one place.</p>
</div>

<div class="tab-bar">
    <button class="tab-btn active" data-tab="oc-merchants" onclick="switchTab(this,'oc-merchants')">üè™
        Merchants</button>
    <button class="tab-btn" data-tab="oc-kyb" onclick="switchTab(this,'oc-kyb')">üìã KYB</button>
    <button class="tab-btn" data-tab="oc-fees" onclick="switchTab(this,'oc-fees')">üí∞ Fees &amp; Risk</button>
    <button class="tab-btn" data-tab="oc-api" onclick="switchTab(this,'oc-api')">üîë API &amp; Webhooks</button>
    <button class="tab-btn" data-tab="oc-settlement" onclick="switchTab(this,'oc-settlement')">üí≥ Settlement</button>
    <button class="tab-btn" data-tab="oc-recon" onclick="switchTab(this,'oc-recon')">üîÑ Reconciliation</button>
    <button class="tab-btn" data-tab="oc-disputes" onclick="switchTab(this,'oc-disputes')">‚ö†Ô∏è Disputes</button>
    <button class="tab-btn" data-tab="oc-cases" onclick="switchTab(this,'oc-cases')">üìÅ Cases</button>
    <button class="tab-btn" data-tab="oc-compliance" onclick="switchTab(this,'oc-compliance')">üõ°Ô∏è Risk &amp;
        Compliance</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 1: MERCHANTS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane active" id="oc-merchants">

    <div class="card">
        <h3>Create Merchant</h3>
        <p class="text-muted">Leave Merchant Code empty to auto-generate based on prefix
            <code>{{ operation_settings.merchant_id_prefix }}</code>.
        </p>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="merchant_create" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Merchant Code (optional)</label><input type="text" name="merchant_code"
                        placeholder="Auto-generate if blank" /></div>
                <div class="form-group"><label>Merchant Name</label><input type="text" name="merchant_name" required />
                </div>
                <div class="form-group"><label>Settlement Currency</label><select name="settlement_currency">{% for c in supported_currencies %}<option>{{ c }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Wallet Type</label><select name="wallet_type">
                        <option value="B">Business (B)</option>
                        <option value="G">Government (G)</option>
                    </select></div>
                <div class="form-group"><label>Owner User (optional)</label><select name="owner_user_id">
                        <option value="">-- none --</option>{% for u in users %}<option value="{{ u.id }}">{{ u.username}}</option>{% endfor %}
                    </select></div>
                <div class="form-group"><label>Contact Email</label><input type="email" name="contact_email" /></div>
                <div class="form-group"><label>Contact Phone</label><input type="text" name="contact_phone" /></div>
                <div class="form-group"><label>Loyalty Earn Rate</label><input type="number" step="0.0001" min="0.0001"
                        name="earn_rate" value="1.0000" required /></div>
                <div class="form-group"><label>Loyalty Redeem Rate</label><input type="number" step="0.0001"
                        min="0.0001" name="redeem_rate" value="1.0000" required /></div>
                <div class="form-group"><label>Single Txn Limit</label><input type="number" step="0.01" min="0.01"
                        name="single_txn_limit" value="50000" required /></div>
                <div class="form-group"><label>Daily Txn Limit</label><input type="number" min="1"
                        name="daily_txn_limit" value="5000" required /></div>
                <div class="form-group"><label>Daily Amount Limit</label><input type="number" step="0.01" min="0.01"
                        name="daily_amount_limit" value="1000000" required /></div>
            </div>
            <div style="display:flex;gap:1.5rem;flex-wrap:wrap;margin-bottom:1rem;">
                <label><input type="checkbox" name="is_high_risk" /> High Risk</label>
                <label><input type="checkbox" name="loyalty_enabled" checked /> Loyalty Enabled</label>
                <label><input type="checkbox" name="supports_b2b" checked /> B2B</label>
                <label><input type="checkbox" name="supports_b2c" checked /> B2C</label>
                <label><input type="checkbox" name="supports_c2b" checked /> C2B</label>
                <label><input type="checkbox" name="supports_p2g" /> P2G</label>
                <label><input type="checkbox" name="supports_g2p" /> G2P</label>
            </div>
            <button class="btn btn-primary" type="submit">Create Merchant</button>
        </form>
    </div>

    <div class="card">
        <h3>Manage Merchants</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Type</th>
                        <th>Owner</th>
                        <th>Contact</th>
                        <th>Capabilities</th>
                        <th>Loyalty</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for m in merchants %}
                    <tr>
                        <td><strong>{{ m.code }}</strong></td>
                        <td>{{ m.name }}</td>
                        <td>{{ m.status }}</td>
                        <td>{{ m.wallet_type }}</td>
                        <td>{% if m.owner %}{{ m.owner.username }}{% else %}-{% endif %}</td>
                        <td>{{ m.contact_email|mask_email }} / {{ m.contact_phone|mask_phone }}</td>
                        <td style="font-size:0.78rem;">{% with cap=m.wallet_capability %}B2B:{% if cap.supports_b2b%}Y{% else %}N{% endif %} B2C:{% if cap.supports_b2c %}Y{% else %}N{% endif %} C2B:{% if cap.supports_c2b %}Y{% else %}N{% endif %}{% endwith %}</td>
                        <td>{% with p=m.loyalty_program %}{% if p.is_enabled %}On{% else %}Off{% endif %}{% endwith %}
                        </td>
                        <td>
                            <form method="post" style="display:flex;gap:0.3rem;flex-wrap:wrap;">
                                {% csrf_token %}<input type="hidden" name="form_type" value="merchant_update" /><input
                                    type="hidden" name="merchant_id" value="{{ m.id }}" />
                                <select name="status">
                                    <option value="active" {% if m.status=="active" %} selected{% endif %}>Active
                                    </option>
                                    <option value="suspended" {% if m.status=="suspended" %} selected{% endif %}>
                                        Suspended</option>
                                    <option value="inactive" {% if m.status=="inactive" %} selected{% endif %}>Inactive
                                    </option>
                                </select>
                                <select name="owner_user_id">
                                    <option value="">-- owner --</option>{% for u in users %}<option value="{{ u.id }}"
                                        {% if m.owner and m.owner.id==u.id %} selected{% endif %}>{{ u.username }}
                                    </option>{% endfor %}
                                </select>
                                <input type="email" name="contact_email" value="{{ m.contact_email }}"
                                    placeholder="email" style="max-width:160px;" />
                                <button class="btn btn-outline" type="submit">Save</button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="9" class="text-muted" style="text-align:center;">No merchants yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h3>User Wallet Type Management</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="user_wallet_type_update" />
            <div class="form-group"><label>User</label><select name="user_id" required>{% for u in users %}<option
                        value="{{ u.id }}">{{ u.username }} ({{ u.wallet_type }})</option>{% endfor %}</select></div>
            <div class="form-group"><label>Wallet Type</label><select name="wallet_type" required>
                    <option value="P">Personal (P)</option>
                    <option value="B">Business (B)</option>
                    <option value="C">Customer (C)</option>
                    <option value="G">Government (G)</option>
                </select></div>
            <button class="btn btn-primary" type="submit">Update Wallet Type</button>
        </form>
    </div>

    <div class="card">
        <h3>Post Cashflow (B2B / B2C / C2B / P2G / G2P)</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="cashflow_event_create" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants%}<option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Flow Type</label><select name="flow_type">{% for value,label in flow_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>User (for B2C/C2B)</label><select name="user_id">
                        <option value="">-- optional --</option>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}
                    </select></div>
                <div class="form-group"><label>Counterparty Merchant (for B2B)</label><select
                        name="counterparty_merchant_id">
                        <option value="">-- optional --</option>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}
                    </select></div>
                <div class="form-group"><label>Currency</label><select name="currency">{% for c in supported_currencies%}<option>{{ c }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Amount</label><input type="number" step="0.01" min="0.01" name="amount"
                        required /></div>
                <div class="form-group"><label>Reference</label><input type="text" name="reference" /></div>
                <div class="form-group"><label>Note</label><input type="text" name="note" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Post Cashflow</button>
        </form>
    </div>

    <div class="card">
        <h3>Recent Cashflow Events</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Merchant</th>
                        <th>Flow</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Net</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Ref</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in cashflow_events %}
                    <tr>
                        <td style="font-size:0.78rem;">{{ e.created_at|date:"d M H:i" }}</td>
                        <td>{{ e.merchant.code }}</td>
                        <td>{{ e.flow_type|upper }}</td>
                        <td>{{ e.amount }} {{ e.currency }}</td>
                        <td>{{ e.fee_amount }}</td>
                        <td>{{ e.net_amount }}</td>
                        <td>{% if e.from_user %}{{ e.from_user.username }}{% else %}-{% endif %}</td>
                        <td>{% if e.to_user %}{{ e.to_user.username }}{% else %}-{% endif %}</td>
                        <td>{{ e.reference|default:"-" }}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="9" class="text-muted" style="text-align:center;">No cashflow events yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h3>Loyalty Event Execution</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="loyalty_event_create" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Customer</label><select name="customer_id" required>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Event Type</label><select name="event_type">{% for value,label in event_type_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Flow Type</label><select name="flow_type">{% for value,label in flow_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Amount</label><input type="number" step="0.01" min="0.01" name="amount" required /></div>
                <div class="form-group"><label>Reference</label><input type="text" name="reference" /></div>
                <div class="form-group" style="grid-column:1/-1;"><label>Note</label><input type="text" name="note" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Post Loyalty Event</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Merchant</th>
                        <th>Customer</th>
                        <th>Type</th>
                        <th>Flow</th>
                        <th>Points</th>
                        <th>Amount</th>
                        <th>Ref</th>
                    </tr>
                </thead>
                <tbody>
                    {% for le in loyalty_events %}
                    <tr>
                        <td style="font-size:0.78rem;">{{ le.created_at|date:"d M H:i" }}</td>
                        <td>{{ le.merchant.code }}</td>
                        <td>{{ le.customer.username }}</td>
                        <td>{{ le.event_type }}</td>
                        <td>{{ le.flow_type|upper }}</td>
                        <td>{{ le.points }}</td>
                        <td>{{ le.amount }} {{ le.currency }}</td>
                        <td>{{ le.reference|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-muted" style="text-align:center;">No loyalty events yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 2: KYB
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="oc-kyb">
    <div class="card">
        <h3>Submit Merchant KYB</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="merchant_kyb_submit" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants%}<option value="{{ m.id }}">{{ m.code }} - {{ m.name }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Legal Name</label><input type="text" name="legal_name" required /></div>
                <div class="form-group"><label>Registration Number</label><input type="text"
                        name="registration_number" /></div>
                <div class="form-group"><label>Tax ID</label><input type="text" name="tax_id" /></div>
                <div class="form-group"><label>Country Code</label><input type="text" name="country_code"
                        maxlength="3" /></div>
                <div class="form-group"><label>Risk Note</label><input type="text" name="risk_note" /></div>
                <div class="form-group"><label>Incorporation Doc URL</label><input type="url"
                        name="incorporation_doc_url" /></div>
                <div class="form-group"><label>License Doc URL</label><input type="url" name="license_doc_url" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Submit KYB</button>
        </form>
    </div>
    <div class="card">
        <h3>KYB Requests</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Merchant</th>
                        <th>Status</th>
                        <th>Legal Name</th>
                        <th>Reg No</th>
                        <th>Maker</th>
                        <th>Checker</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in kyb_requests %}
                    <tr>
                        <td>#{{ req.id }}</td>
                        <td>{{ req.merchant.code }}</td>
                        <td>{% if req.status == "approved" %}<span class="badge-active">{{ req.status }}</span>{% elif req.status == "rejected" %}<span class="badge-blocked">{{ req.status }}</span>{% else%}<span class="badge-pending">{{ req.status }}</span>{% endif %}</td>
                        <td>{{ req.legal_name }}</td>
                        <td>{{ req.registration_number|default:"-" }}</td>
                        <td>{{ req.maker.username }}</td>
                        <td>{% if req.checker %}{{ req.checker.username }}{% else %}-{% endif %}</td>
                        <td>{% if req.status == "pending" %}<form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden" name="form_type"
                                    value="merchant_kyb_decision" /><input type="hidden" name="kyb_request_id"
                                    value="{{ req.id }}" /><select name="decision">
                                    <option value="approved">Approve</option>
                                    <option value="rejected">Reject</option>
                                </select><input type="text" name="checker_note" placeholder="Note"
                                    style="max-width:120px;" /><button class="btn btn-outline"
                                    type="submit">Submit</button></form>{% else %}{{ req.checker_note|default:"-" }}{% endif %}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="8" class="text-muted" style="text-align:center;">No KYB requests yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 3: FEES & RISK
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="oc-fees">
    <div class="card">
        <h3>Merchant Fee Rules</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="merchant_fee_rule_upsert" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants%}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Flow Type</label><select name="flow_type">{% for value,label in flow_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Percent (bps)</label><input type="number" min="0" name="percent_bps"
                        value="0" /></div>
                <div class="form-group"><label>Fixed Fee</label><input type="number" step="0.01" min="0"
                        name="fixed_fee" value="0" /></div>
                <div class="form-group"><label>Minimum Fee</label><input type="number" step="0.01" min="0"
                        name="minimum_fee" value="0" /></div>
                <div class="form-group"><label>Maximum Fee</label><input type="number" step="0.01" min="0"
                        name="maximum_fee" value="0" /></div>
            </div>
            <label style="margin-bottom:1rem;display:flex;gap:0.5rem;"><input type="checkbox" name="is_active"
                    checked /> Active</label>
            <button class="btn btn-primary" type="submit">Save Fee Rule</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Merchant</th>
                        <th>Flow</th>
                        <th>BPS</th>
                        <th>Fixed</th>
                        <th>Min</th>
                        <th>Max</th>
                        <th>Active</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rule in fee_rules %}<tr>
                        <td>{{ rule.merchant.code }}</td>
                        <td>{{ rule.flow_type|upper }}</td>
                        <td>{{ rule.percent_bps }}</td>
                        <td>{{ rule.fixed_fee }}</td>
                        <td>{{ rule.minimum_fee }}</td>
                        <td>{{ rule.maximum_fee }}</td>
                        <td>{% if rule.is_active %}<span class="badge-active">Y</span>{% else %}N{% endif %}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="7" class="text-muted" style="text-align:center;">No fee rules yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Merchant Risk Profile</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="merchant_risk_update" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants%}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Single Txn Limit</label><input type="number" step="0.01" min="0.01"
                        name="single_txn_limit" required /></div>
                <div class="form-group"><label>Daily Txn Limit</label><input type="number" min="1"
                        name="daily_txn_limit" required /></div>
                <div class="form-group"><label>Daily Amount Limit</label><input type="number" step="0.01" min="0.01"
                        name="daily_amount_limit" required /></div>
                <div class="form-group"><label>Reserve Ratio (bps)</label><input type="number" min="0"
                        name="reserve_ratio_bps" value="0" /></div>
                <div class="form-group"><label>Manual Review Threshold</label><input type="number" step="0.01" min="0"
                        name="require_manual_review_above" value="0" /></div>
            </div>
            <label style="margin-bottom:1rem;display:flex;gap:0.5rem;"><input type="checkbox" name="is_high_risk" />
                High Risk</label>
            <button class="btn btn-primary" type="submit">Update Risk Profile</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Merchant</th>
                        <th>Single</th>
                        <th>Daily Count</th>
                        <th>Daily Amount</th>
                        <th>Reserve (bps)</th>
                        <th>High Risk</th>
                    </tr>
                </thead>
                <tbody>
                    {% for risk in risk_profiles %}<tr>
                        <td>{{ risk.merchant.code }}</td>
                        <td>{{ risk.single_txn_limit }}</td>
                        <td>{{ risk.daily_txn_limit }}</td>
                        <td>{{ risk.daily_amount_limit }}</td>
                        <td>{{ risk.reserve_ratio_bps }}</td>
                        <td>{% if risk.is_high_risk %}<span class="badge-blocked">Yes</span>{% else %}No{% endif %}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="6" class="text-muted" style="text-align:center;">No risk profiles yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 4: API & WEBHOOKS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="oc-api">
    <div class="card">
        <h3>Merchant API Credential &amp; Webhook</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="merchant_api_rotate" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants%}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Scopes (csv)</label><input type="text" name="scopes_csv"
                        value="wallet:read,payout:read,webhook:write" /></div>
                <div class="form-group"><label>Webhook URL</label><input type="url" name="webhook_url"
                        placeholder="https://merchant.example/webhook" /></div>
            </div>
            <label style="margin-bottom:1rem;display:flex;gap:0.5rem;"><input type="checkbox" name="is_active"
                    checked /> Credential Active</label>
            <button class="btn btn-primary" type="submit">Rotate API Credential</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Merchant</th>
                        <th>Key ID</th>
                        <th>Scopes</th>
                        <th>Webhook</th>
                        <th>Active</th>
                        <th>Last Rotated</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cred in api_credentials %}<tr>
                        <td>{{ cred.merchant.code }}</td>
                        <td><code>{{ cred.key_id }}</code></td>
                        <td>{{ cred.scopes_csv }}</td>
                        <td>{{ cred.webhook_url|default:"-" }}</td>
                        <td>{% if cred.is_active %}<span class="badge-active">Y</span>{% else %}N{% endif %}</td>
                        <td style="font-size:0.78rem;">{% if cred.last_rotated_at %}{{ cred.last_rotated_at|date:"d M Y H:i" }}{% else %}-{% endif %}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="6" class="text-muted" style="text-align:center;">No API credentials yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Webhook Signature &amp; Replay Dashboard</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="merchant_webhook_validate" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Credential</label><select name="credential_id" required>{% for cred in api_credentials %}<option value="{{ cred.id }}">{{ cred.merchant.code }} - {{ cred.key_id }}
                        </option>{% endfor %}</select></div>
                <div class="form-group"><label>Event Type</label><input type="text" name="event_type"
                        value="payment.status" /></div>
                <div class="form-group"><label>Nonce</label><input type="text" name="nonce" required /></div>
                <div class="form-group"><label>Signature</label><input type="text" name="signature" required /></div>
            </div>
            <div class="form-group"><label>Payload</label><textarea name="payload" rows="3" required></textarea></div>
            <button class="btn btn-primary" type="submit">Validate Webhook</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Merchant</th>
                        <th>Nonce</th>
                        <th>Sig Valid</th>
                        <th>Replay</th>
                        <th>Status</th>
                        <th>Code</th>
                    </tr>
                </thead>
                <tbody>
                    {% for we in webhook_events %}<tr>
                        <td style="font-size:0.78rem;">{{ we.created_at|date:"d M H:i" }}</td>
                        <td>{{ we.credential.merchant.code }}</td>
                        <td>{{ we.nonce }}</td>
                        <td>{% if we.signature_valid %}<span class="badge-active">Y</span>{% else %}<span
                                class="badge-blocked">N</span>{% endif %}</td>
                        <td>{% if we.replay_detected %}<span class="badge-blocked">Y</span>{% else %}N{% endif %}</td>
                        <td>{{ we.status }}</td>
                        <td>{{ we.response_code }}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="7" class="text-muted" style="text-align:center;">No webhook events yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 5: SETTLEMENT
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="oc-settlement">
    <div class="card">
        <h3>Settlement Automation</h3>
        <p class="text-muted">Run batch settlement generation from unsettled merchant cashflow events.</p>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="settlement_automation_run" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Period Start</label><input type="date" name="period_start" /></div>
                <div class="form-group"><label>Period End</label><input type="date" name="period_end" /></div>
                <div class="form-group"><label>Currency (optional)</label><select name="currency">
                        <option value="">All</option>{% for c in supported_currencies %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
                    </select></div>
            </div>
            <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;">
                <label><input type="checkbox" name="create_payouts" /> Auto-create payouts</label>
                <label><input type="checkbox" name="dry_run" checked /> Dry run</label>
            </div>
            <button class="btn btn-primary" type="submit">Run Settlement Automation</button>
        </form>
    </div>
    <div class="card">
        <h3>Settlement Management</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="merchant_settlement_create" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Merchant</label><select name="merchant_id" required>{% for m in merchants%}<option value="{{ m.id }}">{{ m.code }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Currency</label><select name="currency">{% for c in supported_currencies%}<option>{{ c }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Period Start</label><input type="date" name="period_start" /></div>
                <div class="form-group"><label>Period End</label><input type="date" name="period_end" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Generate Settlement Draft</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Merchant</th>
                        <th>Period</th>
                        <th>Gross</th>
                        <th>Fee</th>
                        <th>Net</th>
                        <th>Events</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in settlements %}
                    <tr>
                        <td>{{ s.settlement_no }}</td>
                        <td>{{ s.merchant.code }}</td>
                        <td style="font-size:0.78rem;">{{ s.period_start }} ‚Üí {{ s.period_end }}</td>
                        <td>{{ s.gross_amount }} {{ s.currency }}</td>
                        <td>{{ s.fee_amount }}</td>
                        <td><strong>{{ s.net_amount }}</strong> {{ s.currency }}</td>
                        <td>{{ s.event_count }}</td>
                        <td>{{ s.status }}</td>
                        <td>
                            <form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden"
                                    name="form_type" value="merchant_settlement_update" /><input type="hidden"
                                    name="settlement_id" value="{{ s.id }}" /><select name="status">
                                    <option value="draft" {% if s.status=="draft" %} selected{% endif %}>Draft</option>
                                    <option value="posted" {% if s.status=="posted" %} selected{% endif %}>Posted
                                    </option>
                                    <option value="paid" {% if s.status=="paid" %} selected{% endif %}>Paid</option>
                                </select><button class="btn btn-outline" type="submit">Update</button></form>
                        </td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="9" class="text-muted" style="text-align:center;">No settlements yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Settlement Payout Execution</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="settlement_payout_submit" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Settlement</label><select name="settlement_id" required>{% for s in settlements %}<option value="{{ s.id }}">{{ s.settlement_no }} ‚Äì {{ s.merchant.code }} ‚Äì {{ s.net_amount }} {{ s.currency }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Payout Channel</label><select name="payout_channel">
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="api">API</option>
                        <option value="manual">Manual</option>
                    </select></div>
                <div class="form-group"><label>Destination Account</label><input type="text"
                        name="destination_account" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Submit Payout</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Ref</th>
                        <th>Settlement</th>
                        <th>Merchant</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Channel</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in payouts %}
                    <tr>
                        <td>{{ p.payout_reference }}</td>
                        <td>{{ p.settlement.settlement_no }}</td>
                        <td>{{ p.settlement.merchant.code }}</td>
                        <td>{{ p.amount }} {{ p.currency }}</td>
                        <td>{{ p.status }}</td>
                        <td>{{ p.payout_channel }}</td>
                        <td>
                            <form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden"
                                    name="form_type" value="settlement_payout_decision" /><input type="hidden"
                                    name="payout_id" value="{{ p.id }}" /><select name="decision">
                                    <option value="send">Mark Sent</option>
                                    <option value="settle">Mark Settled</option>
                                    <option value="fail">Mark Failed</option>
                                </select><button class="btn btn-outline" type="submit">Update</button></form>
                        </td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="7" class="text-muted" style="text-align:center;">No payouts yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 6: RECONCILIATION
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="oc-recon">
    <div class="card">
        <h3>Run Reconciliation</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="reconciliation_run_create" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Source</label><input type="text" name="source"
                        value="internal_vs_settlement" /></div>
                <div class="form-group"><label>Currency</label><select name="currency">{% for c in supported_currencies%}<option>{{ c }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Period Start</label><input type="date" name="period_start" /></div>
                <div class="form-group"><label>Period End</label><input type="date" name="period_end" /></div>
                <div class="form-group"><label>External Count</label><input type="number" min="0" name="external_count"
                        value="0" /></div>
                <div class="form-group"><label>External Amount</label><input type="number" step="0.01" min="0"
                        name="external_amount" value="0" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Run Reconciliation</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Run</th>
                        <th>Period</th>
                        <th>Internal</th>
                        <th>External</th>
                        <th>Delta Count</th>
                        <th>Delta Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for run in reconciliation_runs %}<tr>
                        <td>{{ run.run_no }}</td>
                        <td style="font-size:0.78rem;">{{ run.period_start }} ‚Üí {{ run.period_end }}</td>
                        <td>{{ run.internal_count }} / {{ run.internal_amount }} {{ run.currency }}</td>
                        <td>{{ run.external_count }} / {{ run.external_amount }} {{ run.currency }}</td>
                        <td>{{ run.delta_count }}</td>
                        <td>{{ run.delta_amount }} {{ run.currency }}</td>
                        <td>{{ run.status }}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="7" class="text-muted" style="text-align:center;">No reconciliation runs yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Reconciliation Breaks</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Run</th>
                        <th>Reference</th>
                        <th>Issue</th>
                        <th>Delta</th>
                        <th>Status</th>
                        <th>Assigned</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for br in reconciliation_breaks %}
                    <tr>
                        <td>{{ br.run.run_no }}</td>
                        <td>{{ br.reference|default:"-" }}</td>
                        <td>{{ br.issue_type }}</td>
                        <td>{{ br.delta_amount }}</td>
                        <td>{{ br.status }}</td>
                        <td>{% if br.assigned_to %}{{ br.assigned_to.username }}{% else %}-{% endif %}</td>
                        <td>
                            <form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden"
                                    name="form_type" value="reconciliation_break_update" /><input type="hidden"
                                    name="break_id" value="{{ br.id }}" /><select name="status">
                                    <option value="open">Open</option>
                                    <option value="in_review">In Review</option>
                                    <option value="resolved">Resolved</option>
                                </select><select name="assigned_to">
                                    <option value="">-- keep --</option>{% for u in users %}<option value="{{ u.id }}">
                                        {{ u.username }}</option>{% endfor %}
                                </select><input type="text" name="note" placeholder="Note"
                                    style="max-width:120px;" /><button class="btn btn-outline"
                                    type="submit">Update</button></form>
                        </td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="7" class="text-muted" style="text-align:center;">No reconciliation breaks yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 7: DISPUTES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="oc-disputes">
    <div class="card">
        <h3>Refund SLA Escalation Automation</h3>
        <p class="text-muted">Escalate overdue pending refund requests automatically.</p>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="refund_escalation_run" />
            <label style="display:flex;gap:0.5rem;margin-bottom:1rem;"><input type="checkbox" name="dry_run" checked />
                Dry run</label>
            <button class="btn btn-primary" type="submit">Run Refund Escalation</button>
        </form>
    </div>
    <div class="card">
        <h3>Dispute Refund (Maker / Checker)</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="dispute_refund_submit" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Case</label><select name="case_id" required>{% for item in cases %}
                        <option value="{{ item.id }}">{{ item.case_no }} ({{ item.case_type }})</option>{% endfor%}
                    </select></div>
                <div class="form-group"><label>Currency</label><select name="currency">{% for c in supported_currencies%}<option>{{ c }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Amount</label><input type="number" step="0.01" min="0.01" name="amount"
                        required /></div>
                <div class="form-group"><label>Source Cashflow Event ID</label><input type="number" min="1"
                        name="source_cashflow_event_id" /></div>
                <div class="form-group"><label>Reason</label><input type="text" name="reason" /></div>
                <div class="form-group"><label>Maker Note</label><input type="text" name="maker_note" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Submit Refund Request</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Case</th>
                        <th>Merchant</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rr in refund_requests %}
                    <tr>
                        <td>#{{ rr.id }}</td>
                        <td>{{ rr.case.case_no }}</td>
                        <td>{{ rr.merchant.code }}</td>
                        <td>{{ rr.customer.username }}</td>
                        <td>{{ rr.amount }} {{ rr.currency }}</td>
                        <td>{{ rr.status }}</td>
                        <td>{% if rr.status == "pending" %}<form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden" name="form_type"
                                    value="dispute_refund_decision" /><input type="hidden" name="refund_request_id"
                                    value="{{ rr.id }}" /><select name="decision">
                                    <option value="approve">Approve &amp; Execute</option>
                                    <option value="reject">Reject</option>
                                </select><input type="text" name="checker_note" placeholder="Note"
                                    style="max-width:120px;" /><button class="btn btn-outline"
                                    type="submit">Submit</button></form>{% else %}{{ rr.checker_note|default:"-" }}{% endif %}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="7" class="text-muted" style="text-align:center;">No refund requests yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Chargeback Operations</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="chargeback_create" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Case</label><select name="case_id" required>{% for item in cases %}
                        <option value="{{ item.id }}">{{ item.case_no }} ({{ item.case_type }})</option>{% endfor%}
                    </select></div>
                <div class="form-group"><label>Currency</label><select name="currency">{% for c in supported_currencies%}<option>{{ c }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Amount</label><input type="number" step="0.01" min="0.01" name="amount"
                        required /></div>
                <div class="form-group"><label>Reason Code</label><input type="text" name="reason_code"
                        placeholder="e.g. 10.4" /></div>
                <div class="form-group"><label>Network Reference</label><input type="text" name="network_reference" />
                </div>
                <div class="form-group"><label>Due At (YYYY-MM-DDTHH:MM:SS)</label><input type="text" name="due_at" />
                </div>
            </div>
            <button class="btn btn-primary" type="submit">Create Chargeback</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Case</th>
                        <th>Merchant</th>
                        <th>Amount</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Assigned</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cb in chargebacks %}
                    <tr>
                        <td>{{ cb.chargeback_no }}</td>
                        <td>{{ cb.case.case_no }}</td>
                        <td>{{ cb.merchant.code }}</td>
                        <td>{{ cb.amount }} {{ cb.currency }}</td>
                        <td>{{ cb.reason_code|default:"-" }}</td>
                        <td>{{ cb.status }}</td>
                        <td>{% if cb.assigned_to %}{{ cb.assigned_to.username }}{% else %}-{% endif %}</td>
                        <td>
                            <form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden"
                                    name="form_type" value="chargeback_update" /><input type="hidden"
                                    name="chargeback_id" value="{{ cb.id }}" /><select name="status">
                                    <option value="open">Open</option>
                                    <option value="represented">Represented</option>
                                    <option value="won">Won</option>
                                    <option value="lost">Lost</option>
                                    <option value="closed">Closed</option>
                                </select><select name="assigned_to">
                                    <option value="">-- keep --</option>{% for u in users %}<option value="{{ u.id }}">
                                        {{ u.username }}</option>{% endfor %}
                                </select><button class="btn btn-outline" type="submit">Update</button></form>
                        </td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="8" class="text-muted" style="text-align:center;">No chargebacks yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h3>Chargeback Evidence Upload</h3>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}<input type="hidden" name="form_type" value="chargeback_evidence_add" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Chargeback</label><select name="chargeback_id" required>{% for cb in chargebacks %}<option value="{{ cb.id }}">{{ cb.chargeback_no }} - {{ cb.merchant.code }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Document Type</label><input type="text" name="document_type" value="receipt" /></div>
                <div class="form-group"><label>Document URL (optional)</label><input type="url" name="document_url" /></div>
                <div class="form-group"><label>Upload File (optional)</label><input type="file" name="document_file" /></div>
                <div class="form-group"><label>Note</label><input type="text" name="note" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Upload Evidence</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Chargeback</th>
                        <th>Type</th>
                        <th>URL</th>
                        <th>Uploader</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ev in chargeback_evidences %}
                    <tr>
                        <td style="font-size:0.78rem;">{{ ev.created_at|date:"d M H:i" }}</td>
                        <td>{{ ev.chargeback.chargeback_no }}</td>
                        <td>{{ ev.document_type }}</td>
                        <td><a href="{{ ev.document_url }}" target="_blank" rel="noopener">{{ ev.document_url }}</a></td>
                        <td>{% if ev.uploaded_by %}{{ ev.uploaded_by.username }}{% else %}-{% endif %}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-muted" style="text-align:center;">No chargeback evidences yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 8: CASES
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="oc-cases">
    <div class="card">
        <h3>Create Case (Complaint / Dispute / Refund)</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="case_create" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Case Type</label><select name="case_type">{% for value,label in case_type_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Priority</label><select name="case_priority">{% for value,label in case_priority_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}</select>
                </div>
                <div class="form-group"><label>Customer</label><select name="case_customer_id" required>{% for u in users %}<option value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Merchant (optional)</label><select name="case_merchant_id">
                        <option value="">-- none --</option>{% for m in merchants %}<option value="{{ m.id }}">{{ m.code}} - {{ m.name }}</option>{% endfor %}
                    </select></div>
                <div class="form-group" style="grid-column:1/-1;"><label>Title</label><input type="text"
                        name="case_title" required /></div>
            </div>
            <div class="form-group"><label>Description</label><textarea name="case_description" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" type="submit">Create Case</button>
        </form>
    </div>
    <div class="card">
        <h3>Open Cases</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Case</th>
                        <th>Type</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Customer</th>
                        <th>Merchant</th>
                        <th>Assigned</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cases %}
                    <tr>
                        <td><a href="{% url 'case_detail' item.id %}">{{ item.case_no }}</a></td>
                        <td>{{ item.case_type }}</td>
                        <td>{{ item.priority }}</td>
                        <td>{{ item.status }}</td>
                        <td>{{ item.customer.username }}</td>
                        <td>{% if item.merchant %}{{ item.merchant.code }}{% else %}-{% endif %}</td>
                        <td>{% if item.assigned_to %}{{ item.assigned_to.username }}{% else %}-{% endif %}</td>
                        <td>
                            <form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden"
                                    name="form_type" value="case_update" /><input type="hidden" name="case_id"
                                    value="{{ item.id }}" /><select name="status">{% for value,label in case_status_choices %}<option value="{{ value }}" {% if item.status==value %}
                                        selected{% endif %}>{{ label }}</option>{% endfor %}</select><select
                                    name="assigned_to">
                                    <option value="">-- unassigned --</option>{% for u in users %}<option
                                        value="{{ u.id }}" {% if item.assigned_to and item.assigned_to.id==u.id %}
                                        selected{% endif %}>{{ u.username }}</option>{% endfor %}
                                </select><input type="text" name="note" placeholder="Note"
                                    style="max-width:100px;" /><button class="btn btn-outline"
                                    type="submit">Update</button></form>
                            <a class="btn btn-outline" href="{% url 'case_detail' item.id %}" style="margin-top:0.35rem;">Open 360</a>
                        </td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="8" class="text-muted" style="text-align:center;">No cases yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Case Notes Timeline</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Case</th>
                        <th>Author</th>
                        <th>Visibility</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody>
                    {% for note in case_notes_feed %}
                    <tr>
                        <td style="font-size:0.78rem;">{{ note.created_at|date:"d M H:i" }}</td>
                        <td>{{ note.case.case_no }}</td>
                        <td>{{ note.created_by.username }}</td>
                        <td>{% if note.is_internal %}Internal{% else %}External{% endif %}</td>
                        <td>{{ note.note }}</td>
                    </tr>
                    {% endfor %}
                    {% if not case_notes_feed %}
                    <tr>
                        <td colspan="5" class="text-muted" style="text-align:center;">No case notes yet.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 9: RISK & COMPLIANCE
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="oc-compliance">
    <div class="card">
        <h3>Sanction Screening</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="sanction_screening_run" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>User</label><select name="user_id" required>{% for u in users %}<option
                            value="{{ u.id }}">{{ u.username }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Provider</label><input type="text" name="provider" value="internal" />
                </div>
                <div class="form-group"><label>Reference</label><input type="text" name="reference" /></div>
                <div class="form-group"><label>Score (0-1)</label><input type="number" step="0.0001" min="0" max="1"
                        name="score" value="0.1000" /></div>
                <div class="form-group"><label>Note</label><input type="text" name="note" /></div>
            </div>
            <button class="btn btn-primary" type="submit">Run Screening</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Provider</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Ref</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sr in sanction_screenings %}<tr>
                        <td style="font-size:0.78rem;">{{ sr.created_at|date:"d M H:i" }}</td>
                        <td>{{ sr.user.username }}</td>
                        <td>{{ sr.provider }}</td>
                        <td>{{ sr.score }}</td>
                        <td>{{ sr.status }}</td>
                        <td>{{ sr.reference|default:"-" }}</td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="6" class="text-muted" style="text-align:center;">No sanction screenings yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>AML Monitoring Alerts</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>User</th>
                        <th>Merchant</th>
                        <th>Case</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for al in monitoring_alerts %}
                    <tr>
                        <td>#{{ al.id }}</td>
                        <td>{{ al.alert_type }}</td>
                        <td>{{ al.severity }}</td>
                        <td>{{ al.status }}</td>
                        <td>{% if al.user %}{{ al.user.username }}{% else %}-{% endif %}</td>
                        <td>{% if al.merchant %}{{ al.merchant.code }}{% else %}-{% endif %}</td>
                        <td>{% if al.case %}{{ al.case.case_no }}{% else %}-{% endif %}</td>
                        <td>
                            <form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden"
                                    name="form_type" value="monitoring_alert_update" /><input type="hidden"
                                    name="alert_id" value="{{ al.id }}" /><select name="status">
                                    <option value="open">Open</option>
                                    <option value="in_review">In Review</option>
                                    <option value="closed">Closed</option>
                                </select><select name="assigned_to">
                                    <option value="">-- keep --</option>{% for u in users %}<option value="{{ u.id }}">
                                        {{ u.username }}</option>{% endfor %}
                                </select><input type="text" name="note" placeholder="Note"
                                    style="max-width:100px;" /><button class="btn btn-outline"
                                    type="submit">Update</button></form>
                        </td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="8" class="text-muted" style="text-align:center;">No monitoring alerts yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Access Review (SoD) &amp; Compliance</h3>
        <form method="post" style="margin-bottom:1rem;">
            {% csrf_token %}<input type="hidden" name="form_type" value="access_review_run" />
            <button class="btn btn-primary" type="submit">Run SoD Access Review</button>
        </form>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Review</th>
                        <th>User</th>
                        <th>Issue</th>
                        <th>Status</th>
                        <th>Reviewer</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ar in access_reviews %}
                    <tr>
                        <td>{{ ar.review_no }}</td>
                        <td>{{ ar.user.username }}</td>
                        <td>{{ ar.issue_type }}</td>
                        <td>{{ ar.status }}</td>
                        <td>{% if ar.reviewer %}{{ ar.reviewer.username }}{% else %}-{% endif %}</td>
                        <td>
                            <form method="post" style="display:flex;gap:0.3rem;">{% csrf_token %}<input type="hidden"
                                    name="form_type" value="access_review_update" /><input type="hidden"
                                    name="review_id" value="{{ ar.id }}" /><select name="status">
                                    <option value="open">Open</option>
                                    <option value="resolved">Resolved</option>
                                </select><button class="btn btn-outline" type="submit">Update</button></form>
                        </td>
                    </tr>
                    {% empty %}<tr>
                        <td colspan="6" class="text-muted" style="text-align:center;">No access reviews yet.</td>
                    </tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Ledger Hardening Controls</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="accounting_period_close_upsert" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Currency</label><select name="currency">{% for c in supported_currencies%}<option>{{ c }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Action</label><select name="close_action">
                        <option value="close">Close</option>
                        <option value="reopen">Reopen</option>
                    </select></div>
                <div class="form-group"><label>Period Start</label><input type="date" name="period_start" required />
                </div>
                <div class="form-group"><label>Period End</label><input type="date" name="period_end" required /></div>
            </div>
            <button class="btn btn-primary" type="submit">Apply Period Action</button>
        </form>
    </div>
    <div class="card">
        <h3>Journal Backdate (Maker / Checker)</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="journal_backdate_request" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group"><label>Journal Entry</label><select name="entry_id" required>{% for entry in journal_entries %}<option value="{{ entry.id }}">{{ entry.entry_no }} - {{ entry.currency }} - {{ entry.status }}</option>{% endfor %}</select></div>
                <div class="form-group"><label>Requested Date</label><input type="date" name="requested_date" required /></div>
                <div class="form-group" style="grid-column:1/-1;"><label>Reason</label><input type="text" name="reason" required /></div>
            </div>
            <button class="btn btn-primary" type="submit">Submit Backdate Request</button>
        </form>
        <div style="overflow-x:auto;margin-top:1rem;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Entry</th>
                        <th>Requested Date</th>
                        <th>Status</th>
                        <th>Maker</th>
                        <th>Checker</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in backdate_approvals %}
                    <tr>
                        <td>#{{ req.id }}</td>
                        <td>{{ req.entry.entry_no }}</td>
                        <td>{{ req.requested_date }}</td>
                        <td>{{ req.status }}</td>
                        <td>{% if req.maker %}{{ req.maker.username }}{% else %}-{% endif %}</td>
                        <td>{% if req.checker %}{{ req.checker.username }}{% else %}-{% endif %}</td>
                        <td>
                            {% if req.status == "pending" %}
                            <form method="post" style="display:flex;gap:0.3rem;">
                                {% csrf_token %}<input type="hidden" name="form_type" value="journal_backdate_decision" /><input type="hidden" name="approval_id" value="{{ req.id }}" />
                                <select name="decision">
                                    <option value="approve">Approve</option>
                                    <option value="reject">Reject</option>
                                </select>
                                <input type="text" name="checker_note" placeholder="Note" style="max-width:120px;" />
                                <button class="btn btn-outline" type="submit">Submit</button>
                            </form>
                            {% else %}
                            {{ req.checker_note|default:"-" }}
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-muted" style="text-align:center;">No backdate requests yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <h3>Data Retention</h3>
        <form method="post">
            {% csrf_token %}<input type="hidden" name="form_type" value="data_retention_purge" />
            <div class="form-group"><label>Retention Days</label><input type="number" name="days" min="1" value="365" />
            </div>
            <label style="margin-bottom:1rem;display:flex;gap:0.5rem;"><input type="checkbox" name="dry_run" checked />
                Dry Run</label>
            <button class="btn btn-primary" type="submit">Run Data Retention</button>
        </form>
        <form method="post" style="margin-top:1rem;">
            {% csrf_token %}<input type="hidden" name="form_type" value="release_readiness_check" />
            <button class="btn btn-outline" type="submit">Run Release Readiness Snapshot</button>
        </form>
    </div>
</div>

{% endblock %}
