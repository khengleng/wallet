{% extends 'wallets_demo/base.html' %}

{% block title %}RBAC Management - DJ Wallet{% endblock %}
{% block extra_style %}
<style>
    .rbac-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .rbac-metric {
        border: 1px solid var(--border);
        border-radius: 0.8rem;
        background: #fafbff;
        padding: 0.9rem;
    }

    .rbac-metric-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-weight: 600;
    }

    .rbac-metric-value {
        margin-top: 0.3rem;
        font-size: 1.25rem;
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>RBAC Role Management</h2>
    <p class="text-muted">Assign platform roles directly from Backoffice.</p>
    <div class="rbac-metrics">
        <div class="rbac-metric">
            <div class="rbac-metric-label">Total Users</div>
            <div class="rbac-metric-value">{{ total_users }}</div>
        </div>
        <div class="rbac-metric">
            <div class="rbac-metric-label">Users With Roles</div>
            <div class="rbac-metric-value">{{ users_with_roles }}</div>
        </div>
        <div class="rbac-metric">
            <div class="rbac-metric-label">Users Without Roles</div>
            <div class="rbac-metric-value">{{ users_without_roles }}</div>
        </div>
    </div>
    <a class="btn btn-outline mt-4" href="{% url 'backoffice' %}">Back to Backoffice</a>
</div>

<div class="card">
    <h3>Role Coverage</h3>
    <table>
        <thead>
            <tr>
                <th>Role</th>
                <th>Assigned Users</th>
            </tr>
        </thead>
        <tbody>
            {% for metric in role_metrics %}
                <tr>
                    <td>{{ metric.label }} <span class="text-muted">({{ metric.name }})</span></td>
                    <td>{{ metric.user_count }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="2" class="text-muted" style="text-align:center;">No role metrics available.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Users and Roles</h3>
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Current Roles</th>
                <th>Update</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
                <tr>
                    <td>{{ u.username }}</td>
                    <td>{{ u.role_names|join:", " }}</td>
                    <td>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="user_id" value="{{ u.id }}">
                            <div class="flex gap-2" style="flex-wrap: wrap; margin-bottom: 0.75rem;">
                                {% for role_name, role_def in role_items %}
                                    <label style="display:flex; align-items:center; gap:0.25rem; margin-right:0.75rem;">
                                        <input type="checkbox" name="role_{{ role_name }}"
                                               {% if role_name in u.role_names %}checked{% endif %}>
                                        <span>{{ role_name }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                            <button type="submit" class="btn btn-primary">Save Roles</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="3" class="text-muted" style="text-align:center;">No users found.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
